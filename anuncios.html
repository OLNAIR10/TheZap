<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Mural de An√∫ncios - TheZap</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  /* VARI√ÅVEIS DE TEMA */
  :root { 
    --top:#075e54; 
    --bg:#e9f7f2; 
    --card:#fff; 
    --text:#333; 
    --muted:#6b6b6b;
    --accent:#25d366;
    --shadow: 0 2px 5px rgba(0,0,0,0.1);
  }
  body.dark-mode { 
    --top:#202c33; 
    --bg:#111b21; 
    --card:#2a3942; 
    --text:#e9edef; 
    --muted:#8696a0;
    --shadow: 0 4px 10px rgba(0,0,0,0.3);
  }

  /* GERAL */
  body { font-family: system-ui, -apple-system, sans-serif; margin: 0; padding: 0; background: var(--bg); color: var(--text); transition: background 0.3s, color 0.3s; }
  * { box-sizing: border-box; }
  
  /* TOPO */
  .header { background: var(--top); color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
  .header h1 { margin: 0; font-size: 18px; font-weight: 600; }
  .btn-icon { background: none; border: none; color: white; font-size: 20px; cursor: pointer; padding: 0 5px; }

  /* CONTAINER */
  .container { max-width: 600px; margin: 0 auto; padding: 15px; padding-bottom: 80px;}

  /* BOT√ÉO NOVO AN√öNCIO */
  .fab { position: fixed; bottom: 20px; right: 20px; background: var(--top); color: white; width: 56px; height: 56px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 30px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); cursor: pointer; border: none; z-index: 90; transition: background 0.2s; }
  .fab:hover { background: #004d40; }

  /* CARD DE AN√öNCIO */
  .ad-card { background: var(--card); border-radius: 10px; overflow: hidden; margin-bottom: 20px; box-shadow: var(--shadow); transition: background 0.3s, box-shadow 0.3s; }
  .ad-img { 
    width: 100%; 
    height: 200px; 
    object-fit: cover; 
    background: #ccc; 
    cursor: pointer;
    transition: transform 0.3s;
  }
  .ad-card:hover .ad-img { transform: scale(1.02); }

  .ad-content { padding: 15px; }
  .ad-title { font-size: 18px; font-weight: bold; margin: 0 0 5px 0; color: var(--accent); }
  .ad-desc { font-size: 14px; color: var(--text); margin-bottom: 10px; white-space: pre-wrap; line-height: 1.4; }
  .ad-meta { font-size: 12px; color: var(--muted); display: flex; justify-content: space-between; align-items: center; padding-top: 5px; border-top: 1px solid rgba(0,0,0,0.05); }
  .btn-contato { 
    background: var(--accent); 
    color: white; 
    padding: 8px 15px; 
    border-radius: 5px; 
    text-decoration: none; 
    font-weight: bold; 
    font-size: 13px; 
    display: inline-block; 
    margin-top: 10px; 
    transition: opacity 0.2s;
  }
  .btn-contato:hover { opacity: 0.9; }

  /* MODAL DE CRIAR */
  .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 200; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
  .modal.active { display: flex; opacity: 1; pointer-events: auto; }
  .modal-content { background: var(--card); padding: 20px; border-radius: 10px; width: 90%; max-width: 400px; transform: scale(0.9); transition: transform 0.3s ease-out; color: var(--text); }
  .modal.active .modal-content { transform: scale(1); }

  .form-group { margin-bottom: 15px; }
  input, textarea { 
    width: 100%; 
    padding: 10px; 
    border: 1px solid #ccc; 
    border-radius: 5px; 
    outline: none; 
    box-sizing: border-box; 
    background: var(--bg); 
    color: var(--text);
    transition: border-color 0.2s;
  }
  input:focus, textarea:focus { border-color: var(--top); }
  
  /* ESTILOS DO BOT√ÉO SUBMIT E PREVIEW */
  .btn-submit { 
    width: 100%; 
    padding: 12px; 
    background: var(--top); 
    color: white; 
    border: none; 
    border-radius: 5px; 
    font-weight: bold; 
    cursor: pointer; 
    transition: background 0.2s; 
  }
  .btn-submit:hover:not(:disabled) { background: #004d40; }
  .btn-submit:disabled { background: #999; cursor: not-allowed; }
  
  .btn-close { background: transparent; border: none; float: right; font-size: 20px; cursor: pointer; color: var(--muted); }
  
  .image-preview { margin-top: 10px; text-align: center; }
  .image-preview img { max-width: 100%; height: 80px; object-fit: cover; border-radius: 5px; margin-right: 10px; }
</style>
</head>
<body id="body">

<div class="header">
    <a href="/" class="btn-icon">‚¨Ö</a>
    <h1>Mural de An√∫ncios</h1>
    <button class="btn-icon" onclick="toggleDarkMode()">üåô</button>
</div>

<div class="container" id="feed">
    <p style="text-align:center; color:var(--muted); margin-top:20px;" id="loadingStatus">Carregando an√∫ncios...</p>
</div>

<button class="fab" onclick="openModal()">+</button>

<div class="modal" id="modalCriar">
    <div class="modal-content">
        <button class="btn-close" onclick="closeModal()">‚úñ</button>
        <h2 style="margin-top:0;">Novo An√∫ncio</h2>
        
        <div class="form-group">
            <input type="text" id="titulo" placeholder="T√≠tulo (ex: Vendo Bike R$ 500)">
        </div>
        <div class="form-group">
            <textarea id="descricao" rows="4" placeholder="Descri√ß√£o do produto ou servi√ßo..."></textarea>
        </div>
        <div class="form-group">
            <input type="number" id="contato" placeholder="Seu WhatsApp (somente n√∫meros, ex: 5551988887777)">
        </div>
        <div class="form-group">
            <label style="font-size:12px; color:var(--muted);">Foto do An√∫ncio (Opcional):</label>
            <input type="file" id="fileInput" accept="image/*" onchange="previewImage(event)">
            <div class="image-preview" id="imagePreview"></div>
        </div>
        <button class="btn-submit" id="btnPostar" onclick="postarAnuncio()">Publicar An√∫ncio</button>
    </div>
</div>

<script>
    // Configura√ß√µes e Elementos
    const SUPABASE_URL = 'https://wlhgvfcnvteobibzpryb.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndsaGd2ZmNudnRlb2JpYnpwcnliIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQxMjk2NDMsImV4cCI6MjA3OTcwNTY0M30.JAChAqpnrKqw8p4skkxlsLRkPYBJ6Zy2dc5cYzKzn-A';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const el = {
        feed: document.getElementById('feed'),
        modal: document.getElementById('modalCriar'),
        btnPostar: document.getElementById('btnPostar'),
        loadingStatus: document.getElementById('loadingStatus'),
        fileInput: document.getElementById('fileInput'),
        imagePreview: document.getElementById('imagePreview'),
    };
    
    let currentUser = null;
    let realtimeChannel = null;

    // --- UTILS E UI ---

    function toggleDarkMode() {
        const isDark = document.body.classList.toggle('dark-mode');
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
    }

    function openModal() { el.modal.classList.add('active'); }
    
    function closeModal() { 
        el.modal.classList.remove('active'); 
        // Limpa o formul√°rio ao fechar
        document.getElementById('titulo').value = '';
        document.getElementById('descricao').value = '';
        document.getElementById('contato').value = '';
        el.fileInput.value = '';
        el.imagePreview.innerHTML = '';
        el.btnPostar.disabled = false;
        el.btnPostar.textContent = "Publicar An√∫ncio";
    }

    function previewImage(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = e => {
                el.imagePreview.innerHTML = `<img src="${e.target.result}" alt="Preview">`;
            };
            reader.readAsDataURL(file);
        } else {
            el.imagePreview.innerHTML = '';
        }
    }

    // --- AUTHENTICATION & INITIALIZATION ---

    async function init() {
        // Aplica o tema salvo
        if(localStorage.getItem('theme') === 'dark') document.body.classList.add('dark-mode');

        try {
            const {data: { session }} = await supabaseClient.auth.getSession();
            
            if(!session) { 
                alert("Sua sess√£o expirou. Fa√ßa login para acessar o mural."); 
                window.location.href='/'; 
                return; 
            }
            currentUser = session.user;
            
            setupRealtime(); // Configura o Realtime para atualiza√ß√µes instant√¢neas
            fetchAnuncios(); // Carrega os an√∫ncios iniciais
            
        } catch(e) {
            console.error("Erro na inicializa√ß√£o:", e);
            alert("Falha ao carregar a sess√£o. Tente novamente.");
            window.location.href='/';
        }
    }
    init();

    // --- REALTIME ---

    function setupRealtime() {
        if (realtimeChannel) return; // Evita duplicidade

        realtimeChannel = supabaseClient.channel('anuncios_channel');
        
        realtimeChannel
            .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'anuncios' }, payload => {
                // Adiciona o novo an√∫ncio no topo da lista
                if (payload.new) renderAnuncio(payload.new, true);
                el.loadingStatus.style.display = 'none'; // Esconde a mensagem de 'vazio' se o primeiro item chega
            })
            // Voc√™ pode adicionar eventos UPDATE e DELETE aqui se quiser moderar o feed
            .subscribe((status) => {
                if (status === 'SUBSCRIBED') console.log("Realtime Mural: Subscrito com sucesso.");
                if (status === 'CHANNEL_ERROR') console.error("Realtime Mural: Erro no canal.");
            });
    }

    // --- FETCH & RENDER ---

    function renderAnuncio(ad, prepend = false) {
        const date = new Date(ad.created_at).toLocaleDateString('pt-BR');
        const imgHtml = ad.imagem_url ? `<img src="${ad.imagem_url}" class="ad-img" onclick="window.open('${ad.imagem_url}')">` : '';
        
        // Garante que o contato tenha o prefixo correto para o link do WhatsApp
        const formattedContato = ad.contato.replace(/\D/g, ''); // Remove caracteres n√£o num√©ricos
        const btnZap = formattedContato ? `<a href="https://wa.me/55${formattedContato}?text=Ol√°! Vi seu an√∫ncio: ${ad.titulo}. Tenho interesse." target="_blank" class="btn-contato">üí¨ Falar com Vendedor</a>` : '';
        
        const card = document.createElement('div');
        card.className = 'ad-card';
        card.id = `ad-${ad.id}`;

        card.innerHTML = `
            ${imgHtml}
            <div class="ad-content">
                <div class="ad-title">${ad.titulo}</div>
                <div class="ad-desc">${ad.descricao}</div>
                ${btnZap}
                <div class="ad-meta">
                    <span>Vendedor: ${ad.autor_nome || 'Usu√°rio TheZap'}</span>
                    <span>Publicado em: ${date}</span>
                </div>
            </div>
        `;
        
        if (prepend) {
            el.feed.prepend(card); // Adiciona no in√≠cio (mais novo)
        } else {
            el.feed.appendChild(card); // Adiciona no final
        }
    }

    async function fetchAnuncios() {
        el.loadingStatus.textContent = 'Carregando an√∫ncios...';
        el.loadingStatus.style.display = 'block';

        try {
            const { data, error } = await supabaseClient.from('anuncios').select('*').order('created_at', { ascending: false });
            
            if(error) throw error;

            el.feed.innerHTML = ''; // Limpa o feed
            
            if(data.length === 0) {
                el.loadingStatus.textContent = 'Nenhum an√∫ncio ainda. Seja o primeiro!';
                el.loadingStatus.style.display = 'block';
                return;
            }

            data.forEach(ad => renderAnuncio(ad));
            el.loadingStatus.style.display = 'none';
            
        } catch(e) {
            console.error("Erro ao buscar an√∫ncios:", e);
            el.loadingStatus.textContent = '‚ùå Falha ao carregar os an√∫ncios.';
            el.loadingStatus.style.display = 'block';
        }
    }

    // --- POSTING ---

    async function postarAnuncio() {
        const titulo = document.getElementById('titulo').value.trim();
        const desc = document.getElementById('descricao').value.trim();
        const contato = document.getElementById('contato').value.replace(/\D/g, ''); // Limpa o contato
        const file = el.fileInput.files[0];

        if(!titulo || !desc) { alert("Preencha o T√≠tulo e a Descri√ß√£o!"); return; }

        el.btnPostar.textContent = "Publicando...";
        el.btnPostar.disabled = true;

        let imgUrl = null;
        try {
            if(file) {
                const extension = file.name.split('.').pop();
                const name = `ads/${currentUser.id}_${Date.now()}.${extension}`;
                
                // Upload do arquivo
                const { error: uploadError } = await supabaseClient.storage.from('arquivos').upload(name, file, { 
                    contentType: file.type,
                    cacheControl: '3600'
                });
                
                if (uploadError) throw uploadError;
                
                imgUrl = supabaseClient.storage.from('arquivos').getPublicUrl(name).data.publicUrl;
            }

            // Inser√ß√£o no banco de dados
            const { error: insertError } = await supabaseClient.from('anuncios').insert([{
                titulo: titulo,
                descricao: desc,
                contato: contato,
                imagem_url: imgUrl,
                user_id: currentUser.id,
                autor_nome: currentUser.user_metadata.full_name
            }]);

            if(insertError) throw insertError;

            alert("An√∫ncio publicado com sucesso!");
            closeModal();
            
        } catch(e) {
            console.error("Erro no postarAnuncio:", e);
            alert(`Falha ao publicar. Erro: ${e.message || 'Verifique sua conex√£o ou permiss√µes.'}`);
        } finally {
            el.btnPostar.textContent = "Publicar An√∫ncio";
            el.btnPostar.disabled = false;
        }
    }
</script>
</body>
</html>
