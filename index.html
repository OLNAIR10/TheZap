<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Chat Refatorado - Supabase + WebRTC + Push</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { margin:0; font-family: sans-serif; background:#e5ddd5; }
    #app{ display:flex; flex-direction:column; height:100vh; }
    #messages{ flex:1; overflow-y:auto; padding:10px; }
    #inputArea{ display:flex; padding:10px; gap:10px; background:#fff; }
    #inputArea input{ flex:1; padding:10px; border-radius:6px; border:1px solid #ccc; }
    #inputArea button{ padding:10px 16px; border:none; border-radius:6px; background:#128C7E; color:#fff; }
    #loginModal{ position:fixed; top:0; left:0; right:0; bottom:0; background:#0008; display:flex; align-items:center; justify-content:center; }
    #loginBox{ background:#fff; padding:20px; border-radius:8px; width:300px; }
  </style>
</head>
<body>
<div id="loginModal">
  <div id="loginBox">
    <h3>Entrar</h3>
    <input id="email" placeholder="Email" style="width:100%;margin-bottom:8px;" />
    <input id="password" type="password" placeholder="Senha" style="width:100%;margin-bottom:8px;" />
    <button onclick="login()" style="width:100%;">Login</button>
  </div>
</div>

<div id="app" style="display:none;">
  <div id="messages"></div>
  <div id="inputArea">
    <input id="textInput" placeholder="Digite..." />
    <input id="fileInput" type="file" />
    <button onclick="sendMessage()">Enviar</button>
  </div>
</div>

<script>
/* =========================
   CONFIGURAÇÃO SUPABASE
========================= */
const sb = supabase.createClient(
  "https://YOUR-PROJECT.supabase.co", 
  "YOUR-ANON-KEY"
);
let user = null;
let callChannel = null;
let autoCallTargetId = null;

/* =========================
   LOGIN
========================= */
async function login(){
  const email = document.getElementById('email').value;
  const password = document.getElementById('password').value;

  const { data, error } = await sb.auth.signInWithPassword({ email, password });
  if(error){ alert(error.message); return; }

  user = data.user;
  initializeChat();
}

/* =========================
   MENSAGENS
========================= */
function renderMessage(msg){
  const div = document.createElement('div');
  div.textContent = msg.email + ": " + msg.text;
  document.getElementById('messages').appendChild(div);
}

async function sendMessage(){
  if(!user) return;
  const text = textInput.value.trim();
  if(!text) return;
  await sb.from('messages').insert({ user_id:user.id, text, email:user.email });
  textInput.value = '';
}

async function loadHistory(){
  const { data } = await sb.from('messages').select('*').order('created_at',{ascending:true});
  document.getElementById('messages').innerHTML = '';
  data.forEach(renderMessage);
}

function subscribeToMessages(){
  if(window.chatChannel) sb.removeChannel(window.chatChannel);
  window.chatChannel = sb.channel('public:messages')
    .on('postgres_changes',{event:'INSERT',schema:'public',table:'messages'},payload=>{
      renderMessage(payload.new);
    })
    .subscribe();
}

/* =========================
   UPLOAD
========================= */
async function uploadFile(file){
  if(!file || !user) return;
  const safeName = file.name.replace(/[^a-z0-9.]/gi,'_').toLowerCase();
  const path = `${user.id}/${Date.now()}_${safeName}`;
  await sb.storage.from('chat-media').upload(path,file);
  await sb.from('messages').insert({ user_id:user.id, text:`[Arquivo]: ${path}`, email:user.email });
}
fileInput.addEventListener('change',()=>uploadFile(fileInput.files[0]));

/* =========================
   VIDEOCALL + SIGNALING
========================= */
function getUrlParameter(name) {
  const regex = new RegExp('[?&]'+name+'=([^&#]*)');
  const r = regex.exec(location.search);
  return r ? decodeURIComponent(r[1]) : '';
}

function setupCallChannelAndStartAutoCall(){
  if(!user) return;
  if(!callChannel){
    callChannel = sb.channel('call_room_'+user.id)
      .on('broadcast',{event:'signal'},handleSignalMessage)
      .subscribe();
  }
  if(autoCallTargetId && autoCallTargetId!==user.id){
    startVideoCall(autoCallTargetId, user.email.split('@')[0]);
  }
}

function startVideoCall(targetId, callerName){
  console.log('Chamando', targetId, 'por', callerName);
}
function handleSignalMessage(msg){ console.log('Sinal recebido:', msg); }

/* =========================
   INICIALIZAÇÃO
========================= */
function initializeChat(){
  loginModal.style.display='none';
  app.style.display='flex';

  loadHistory();
  subscribeToMessages();

  autoCallTargetId = getUrlParameter('target');
  setupCallChannelAndStartAutoCall();
}

sb.auth.getSession().then(({data:{session}})=>{
  if(session){ user = session.user; initializeChat(); }
});

</script>
</body>
</html>
