<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Quick Task - Chat & Push</title>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
    :root {
        --bg: #e5ddd5;
        --panel: #fff;
        --accent: #128c7e;
        --text: #111;
        --radius: 12px;
    }

    body {
        margin: 0;
        background: var(--bg);
        font-family: Arial, sans-serif;
        display: flex;
        flex-direction: column;
        height: 100vh;
    }

    header {
        background: var(--accent);
        padding: 16px;
        color: white;
        font-size: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    #menu {
        font-size: 26px;
        cursor: pointer;
    }

    #chat {
        flex: 1;
        overflow-y: auto;
        padding: 10px;
        background: var(--bg);
    }

    #input-area {
        background: var(--panel);
        padding: 10px;
        display: flex;
        gap: 10px;
    }

    #msg {
        flex: 1;
        padding: 10px;
        border-radius: var(--radius);
        border: 1px solid #bbb;
    }

    button {
        padding: 10px 16px;
        border: none;
        border-radius: var(--radius);
        background: var(--accent);
        color: white;
        cursor: pointer;
    }
</style>
</head>

<body>

<header>
    Quick Task
    <div id="menu">⋮</div>
</header>

<div id="chat"></div>

<div id="input-area">
    <input id="msg" placeholder="Digite uma mensagem..." />
    <button onclick="sendMessage()">Enviar</button>
</div>

<script>
/* ---------------------------------------
   CONFIGURAÇÃO DO SUPABASE
-----------------------------------------*/
const supabase = supabase.createClient(
    "https://YOUR-PROJECT.supabase.co",
    "YOUR-ANON-KEY"
);

/* ---------------------------------------
   REGISTRAR SERVICE WORKER
-----------------------------------------*/
async function registerSW() {
    if ("serviceWorker" in navigator) {
        try {
            const reg = await navigator.serviceWorker.register("/sw.js");
            console.log("SW registrado:", reg);
        } catch (e) {
            console.error("Erro ao registrar SW:", e);
        }
    }
}
registerSW();

/* ---------------------------------------
   INSCREVER PUSH COM SUAS CHAVES VAPID
-----------------------------------------*/
const vapidPublic = "BEEvF0xTsqZwJkfEsuA5y7ybd3iT7iN82R5E5BRv8GmTgEoSZoXbe4v0XJXBm5dSYI3Lw7p1oL2Vj2nJbX0LZq4";

async function subscribePush() {
    const reg = await navigator.serviceWorker.ready;

    const sub = await reg.pushManager.subscribe({
        userVisibleOnly: true,
        applicationServerKey: urlBase64ToUint8Array(vapidPublic)
    });

    console.log("Push Sub:", sub);

    // Salvar no Supabase
    await supabase.from("subscriptions").insert({
        endpoint: sub.endpoint,
        p256dh: arrayBufferToBase64(sub.getKey("p256dh")),
        auth: arrayBufferToBase64(sub.getKey("auth")),
        user_email: "olnair11pereira@gmail.com"
    });

    alert("Push Notification ativado!");
}

// Conversão necessária para VAPID
function urlBase64ToUint8Array(base64) {
    const padding = "=".repeat((4 - (base64.length % 4)) % 4);
    const base64Safe = (base64 + padding).replace(/-/g, "+").replace(/_/g, "/");
    const raw = window.atob(base64Safe);
    const output = new Uint8Array(raw.length);
    for (let i = 0; i < raw.length; ++i) output[i] = raw.charCodeAt(i);
    return output;
}

function arrayBufferToBase64(buffer) {
    let binary = "";
    const bytes = new Uint8Array(buffer);
    bytes.forEach(b => binary += String.fromCharCode(b));
    return btoa(binary);
}

/* ---------------------------------------
   CHAT - ENVIAR MENSAGEM
-----------------------------------------*/
async function sendMessage() {
    const text = document.getElementById("msg").value;
    if (!text.trim()) return;

    await supabase.from("messages").insert({
        text,
        sender: "Você",
        created_at: new Date()
    });

    document.getElementById("msg").value = "";
}

/* ---------------------------------------
   RECEBER MENSAGENS EM TEMPO REAL
-----------------------------------------*/
supabase
    .channel("chat")
    .on("postgres_changes", { event: "INSERT", schema: "public", table: "messages" },
        payload => {
            const m = payload.new;
            const chat = document.getElementById("chat");
            chat.innerHTML += `<p><strong>${m.sender}</strong>: ${m.text}</p>`;
            chat.scrollTop = chat.scrollHeight;
        }
    )
    .subscribe();

</script>

</body>
  </html>
