<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>TheZap Pro</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<style>
  /* --- CORES E VARIÁVEIS --- */
  :root{ 
    --header-bg: #008069; 
    --bg-chat: #e7f5f0;   
    --msg-in: #ffffff; 
    --msg-out: #e7ffdb;   
    --send-btn: #008069;
    --text-primary: #111b21;
    --text-secondary: #667781;
    --danger: #d32f2f; /* Vermelho para gravar/apagar */
  }
  
  body { margin:0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg-chat); display:flex; justify-content:center; height: 100dvh; overflow:hidden; }
  
  .card { width:100%; max-width:720px; background:var(--bg-chat); display:flex; flex-direction:column; height:100%; position: relative; }
  
  /* --- TOPO --- */
  .topbar { background-color: var(--header-bg); color: white; padding: 10px 15px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 1px 3px rgba(0,0,0,0.2); z-index: 10; flex-shrink: 0;}
  .top-left { display: flex; align-items: center; gap: 10px; }
  .app-name { font-weight: bold; font-size: 20px; }
  .status { font-size: 12px; opacity: 0.9; }

  /* --- MENSAGENS --- */
  .messages-wrap { flex:1; overflow-y:auto; padding:15px; display:flex; flex-direction:column; gap:8px; background-color: var(--bg-chat); scroll-behavior: smooth; }
  
  .bubble { 
    max-width: 80%; 
    padding: 6px 8px; /* Padding menor para acomodar mídia */
    border-radius: 8px; 
    background: var(--msg-in); 
    align-self: flex-start; 
    font-size: 15px; 
    box-shadow: 0 1px 2px rgba(0,0,0,0.1); 
    color: var(--text-primary); 
    position: relative;
    word-break: break-word;
  }
  .bubble.me { background: var(--msg-out); align-self: flex-end; }
  .bubble.pending { opacity: 0.6; }
  
  .bubble-autor { font-size:11px; font-weight:bold; color: #e542a3; margin-bottom:4px; display: block; padding-left: 4px; }
  .bubble.me .bubble-autor { display: none; }

  /* --- PADRONIZAÇÃO DE MÍDIA (FOTOS E ARQUIVOS) --- */
  .media-box {
      width: 260px; /* Tamanho padrão fixo */
      max-width: 100%;
      height: 260px; /* Altura fixa para imagens ficarem quadradas */
      overflow: hidden;
      border-radius: 6px;
      margin-bottom: 5px;
      position: relative;
      background: #f0f0f0;
      display: flex;
      align-items: center;
      justify-content: center;
  }
  .media-box img {
      width: 100%;
      height: 100%;
      object-fit: cover; /* Corta a imagem para preencher o quadrado sem esticar */
      cursor: pointer;
  }
  
  /* Arquivos (PDFs etc) */
  .file-box {
      width: 260px; /* Mesmo tamanho padrão */
      max-width: 100%;
      padding: 10px;
      background: rgba(0,0,0,0.05);
      border-radius: 6px;
      display: flex;
      align-items: center;
      gap: 10px;
      box-sizing: border-box;
      text-decoration: none;
      color: #333;
      margin-bottom: 5px;
  }

  /* Mensagem Apagada */
  .msg-deleted { font-style: italic; color: #888; display: flex; align-items: center; gap: 5px; padding: 5px; }

  /* Rodapé da mensagem (Hora e Icones) */
  .meta-row { display: flex; justify-content: space-between; align-items: flex-end; padding-left: 4px; padding-right: 2px;}
  .btn-delete { border: none; background: none; color: #d32f2f; font-size: 16px; cursor: pointer; padding: 0; opacity: 0.5; }
  .btn-delete:hover { opacity: 1; }
  .meta-info { font-size: 10px; color: var(--text-secondary); display: flex; align-items: center; gap: 3px; }

  /* --- BARRA DE DIGITAÇÃO --- */
  .composer { padding: 8px 10px; background: #f0f2f5; display: flex; align-items: center; gap: 8px; min-height: 50px; flex-shrink: 0; }
  
  .input-container { flex: 1; background: white; border-radius: 25px; padding: 8px 15px; display: flex; align-items: center; position: relative; height: 40px; }
  
  /* Texto Normal */
  #txt { flex:1; border:none; outline:none; background: transparent; font-size: 16px; color: var(--text-primary); width: 100%; }
  
  /* Aviso de Gravação VERMELHO */
  #recording-ui { 
      display: none; /* Oculto por padrão */
      color: var(--danger); 
      font-weight: bold; 
      align-items: center; 
      gap: 10px; 
      width: 100%;
      animation: pulseText 1.5s infinite;
  }
  @keyframes pulseText { 0% {opacity: 1;} 50% {opacity: 0.6;} 100% {opacity: 1;} }

  .btn-icon { background: none; border: none; color: #54656f; cursor: pointer; padding: 5px; }
  .btn-send-circle { background: var(--send-btn); color: white; width: 45px; height: 45px; border-radius: 50%; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0; }
  
  /* Botão Mic Ativo */
  .mic-active { background: var(--danger) !important; color: white !important; border-radius: 50%; width: 45px; height: 45px; display: flex; justify-content: center; align-items: center; box-shadow: 0 0 10px rgba(211, 47, 47, 0.5); }

  /* Preview de arquivo */
  .preview-bar { background: #e9edef; padding: 10px; display: none; border-top: 1px solid #ddd; align-items: center; gap: 10px; }
  .preview-bar.active { display: flex; }

  /* MODAL */
  .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--header-bg); z-index: 100; display: flex; align-items: center; justify-content: center; }
  .modal-box { background: white; padding: 30px; border-radius: 5px; width: 85%; max-width: 320px; text-align: center; }
  .modal-box input { width: 100%; padding: 10px; margin: 15px 0; border: 1px solid #ccc; font-size: 16px; box-sizing: border-box; }
  .btn-enter { background: var(--header-bg); color: white; padding: 10px; width: 100%; border: none; font-weight: bold; cursor: pointer; border-radius: 4px; }
  .hidden { display: none !important; }
</style>
</head>
<body>

<div class="card">
    <div class="topbar">
        <div class="top-left">
            <span class="material-icons">flash_on</span>
            <div>
                <div class="app-name">TheZap Pro</div>
                <div class="status" id="roomDisplay">Online</div>
            </div>
        </div>
        <span class="material-icons" onclick="window.location.reload()">refresh</span>
    </div>

    <div id="messagesWrap" class="messages-wrap"></div>

    <!-- Preview de Anexo -->
    <div id="previewBar" class="preview-bar">
        <span class="material-icons" style="color: var(--send-btn);">description</span>
        <span id="fileNamePreview" style="flex:1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;"></span>
        <button class="btn-icon" onclick="cancelAttachment()"><span class="material-icons">close</span></button>
    </div>

    <!-- Footer de Digitação -->
    <div class="composer">
        <input type="file" id="fileInput" style="display: none;" onchange="handleFileSelect()">
        
        <button class="btn-icon" onclick="document.getElementById('fileInput').click()">
            <span class="material-icons" style="transform: rotate(45deg);">attach_file</span>
        </button>

        <div class="input-container">
            <!-- Input de Texto -->
            <input type="text" id="txt" placeholder="Mensagem..." autocomplete="off">
            
            <!-- Texto Vermelho de Gravação -->
            <div id="recording-ui">
                <span class="material-icons">mic</span>
                GRAVANDO ÁUDIO... <span id="recTimer">0:00</span>
            </div>
        </div>

        <!-- Botão Mic / Enviar -->
        <button id="micBtn" class="btn-icon" 
            onmousedown="handleMicPress(event)" 
            onmouseup="handleMicRelease()" 
            ontouchstart="handleMicPress(event)" 
            ontouchend="handleMicRelease()">
            <span class="material-icons">mic</span>
        </button>

        <button id="sendBtn" class="btn-send-circle" onclick="send()" style="display: none;">
            <span class="material-icons">send</span>
        </button>
    </div>
</div>

<div id="loginRoomModal" class="modal-overlay">
    <div class="modal-box">
        <h2>Entrar</h2>
        <input type="text" id="inputSala" placeholder="Nome da sala (ex: familia)">
        <button class="btn-enter" onclick="entrarSala()">ENTRAR</button>
    </div>
</div>

<script>
    // --- SUPABASE CONFIG ---
    const SUPABASE_URL = 'https://zlppiyhqlhppbhkurisr.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpscHBpeWhxbGhwcGJoa3VyaXNyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4NjA0MzYsImV4cCI6MjA3OTQzNjQzNn0.ybVSaBl18pz8OQbtL65Fqn3dIQ4H8qd4OuGRp6ngFnI';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // --- VARIÁVEIS ---
    let currentUser = null;
    let currentRoom = null;
    let fileToSend = null;
    let mediaRecorder = null;
    let audioChunks = [];
    let isRecording = false;
    let recStartTime = 0;
    let recInterval = null;
    let pressTimer;

    const el = {
        txt: document.getElementById('txt'),
        recUI: document.getElementById('recording-ui'),
        recTimer: document.getElementById('recTimer'),
        sendBtn: document.getElementById('sendBtn'),
        micBtn: document.getElementById('micBtn'),
        previewBar: document.getElementById('previewBar'),
        messagesWrap: document.getElementById('messagesWrap')
    };

    // 1. INICIALIZAÇÃO
    async function init() {
        const {data} = await supabaseClient.auth.getSession();
        if(!data.session) return window.location.href = '/';
        currentUser = data.session.user;
        el.txt.onkeydown = (e) => { if(e.key === 'Enter') send(); };
        el.txt.oninput = toggleButtons;
    }
    init();

    function toggleButtons() {
        if(isRecording) return; // Se grava, não mexe
        const hasContent = el.txt.value.trim() !== '' || fileToSend;
        el.sendBtn.style.display = hasContent ? 'flex' : 'none';
        el.micBtn.style.display = hasContent ? 'none' : 'flex';
    }

    function entrarSala() {
        const sala = document.getElementById('inputSala').value.trim().toLowerCase().replace(/\s/g, '');
        if(!sala) return;
        currentRoom = sala;
        document.getElementById('roomDisplay').textContent = "Sala: " + sala;
        document.getElementById('loginRoomModal').classList.add('hidden');
        fetchMessages();
        setupRealtime();
    }

    // 2. LÓGICA DE GRAVAÇÃO (VISUAL VERMELHO)
    async function startRecording() {
        if (isRecording) return;
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];
            mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
            
            mediaRecorder.onstart = () => {
                isRecording = true;
                // UI VERMELHA
                el.txt.style.display = 'none';
                el.recUI.style.display = 'flex';
                el.micBtn.classList.add('mic-active');
                
                // Cronômetro
                recStartTime = Date.now();
                el.recTimer.textContent = "0:00";
                recInterval = setInterval(() => {
                    const sec = Math.floor((Date.now() - recStartTime)/1000);
                    el.recTimer.textContent = `0:${sec<10?'0':''}${sec}`;
                }, 1000);
            };

            mediaRecorder.onstop = () => {
                isRecording = false;
                clearInterval(recInterval);
                // RESETA UI
                el.txt.style.display = 'block';
                el.recUI.style.display = 'none';
                el.micBtn.classList.remove('mic-active');
                
                stream.getTracks().forEach(t => t.stop());
                uploadAudio();
            };
            
            mediaRecorder.start();
        } catch (e) {
            alert("Ative o microfone!");
        }
    }
    function stopRecording() { if (mediaRecorder && isRecording) mediaRecorder.stop(); }
    function handleMicPress(e) { e.preventDefault(); pressTimer = setTimeout(startRecording, 300); }
    function handleMicRelease() { clearTimeout(pressTimer); stopRecording(); }

    async function uploadAudio() {
        const blob = new Blob(audioChunks, { type: 'audio/webm' });
        if(blob.size < 2000) return;
        fileToSend = blob;
        fileToSend.isAudio = true;
        send();
    }

    // 3. ENVIO E ANEXOS
    function handleFileSelect() {
        const file = document.getElementById('fileInput').files[0];
        if (file) {
            fileToSend = file;
            el.previewBar.classList.add('active');
            document.getElementById('fileNamePreview').textContent = file.name;
            toggleButtons();
        }
    }
    function cancelAttachment() {
        fileToSend = null;
        document.getElementById('fileInput').value = '';
        el.previewBar.classList.remove('active');
        toggleButtons();
    }

    async function send() {
        const text = el.txt.value.trim();
        if(!text && !fileToSend) return;

        el.txt.value = '';
        cancelAttachment(); // Limpa UI de anexo

        let tipo = 'text';
        let finalUrl = text;
        
        if (fileToSend) {
            if(fileToSend.isAudio) tipo = 'audio';
            else if(fileToSend.type.includes('image')) tipo = 'imagem';
            else tipo = 'arquivo';

            // Upload
            const folder = tipo === 'audio' ? 'private_audio' : 'private_files';
            const name = `${folder}/${currentRoom}/${Date.now()}_${Math.floor(Math.random()*1000)}`;
            const { error } = await supabaseClient.storage.from('arquivos').upload(name, fileToSend);
            if(!error) {
                const { data } = supabaseClient.storage.from('arquivos').getPublicUrl(name);
                finalUrl = data.publicUrl;
            }
            fileToSend = null;
        }

        await supabaseClient.from('banco').insert([{
            texto: finalUrl,
            user_id: currentUser.id,
            autor_nome: currentUser.user_metadata.full_name || 'User',
            sala_id: currentRoom,
            tipo: tipo
        }]);
    }

    // 4. DELETAR MENSAGEM
    async function deleteMessage(id) {
        if(!confirm("Apagar mensagem para todos?")) return;
        // Não remove do banco, apenas atualiza o status para mostrar "Apagada"
        await supabaseClient.from('banco')
            .update({ texto: 'deleted', tipo: 'deleted' })
            .eq('id', id);
    }

    // 5. RENDERIZAÇÃO
    function renderMessage(msg) {
        // Se a mensagem já existe (por exemplo, atualização de deletada), substitui
        const existing = document.getElementById(msg.id);
        
        const isMe = msg.user_id === currentUser.id;
        const div = existing || document.createElement('div');
        div.className = `bubble ${isMe ? 'me' : ''}`;
        div.id = msg.id;

        // Conteúdo
        let contentHTML = '';
        
        // Se foi apagada
        if(msg.tipo === 'deleted') {
            contentHTML = `<div class="msg-deleted"><span class="material-icons" style="font-size:16px">block</span> Mensagem apagada</div>`;
        } 
        // Tipos normais
        else if(msg.tipo === 'imagem') {
            contentHTML = `<div class="media-box"><img src="${msg.texto}" onclick="window.open(this.src)"></div>`;
        } else if(msg.tipo === 'arquivo') {
            contentHTML = `<a href="${msg.texto}" target="_blank" class="file-box"><span class="material-icons">description</span> Arquivo PDF/Doc</a>`;
        } else if(msg.tipo === 'audio') {
            contentHTML = `
                <div style="display:flex; align-items:center; gap:5px; width: 200px; padding: 5px 0;">
                    <button style="border:none;background:#ccc;border-radius:50%;width:30px;height:30px;cursor:pointer" onclick="this.nextElementSibling.play()">▶</button>
                    <audio src="${msg.texto}"></audio>
                    <span style="font-size:12px;color:#666; margin-left: auto;">Áudio</span>
                </div>`;
        } else {
            contentHTML = `<span style="font-size:15px">${msg.texto}</span>`;
        }

        const time = new Date(msg.created_at).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        
        // Botão de lixeira (só aparece se for eu e não estiver deletada)
        const deleteBtn = (isMe && msg.tipo !== 'deleted') 
            ? `<button class="btn-delete" onclick="deleteMessage('${msg.id}')"><span class="material-icons" style="font-size:14px">delete</span></button>` 
            : '';

        div.innerHTML = `
            <span class="bubble-autor">${msg.autor_nome}</span>
            ${contentHTML}
            <div class="meta-row">
                ${deleteBtn}
                <div class="meta-info">
                    ${time} 
                    ${isMe ? '<span class="material-icons" style="font-size:12px">done_all</span>' : ''}
                </div>
            </div>
        `;

        if(!existing) {
            el.messagesWrap.appendChild(div);
            setTimeout(() => el.messagesWrap.scrollTop = el.messagesWrap.scrollHeight, 100);
        }
    }

    async function fetchMessages() {
        const { data } = await supabaseClient.from('banco').select('*').eq('sala_id', currentRoom).order('created_at');
        el.messagesWrap.innerHTML = '';
        if(data) data.forEach(renderMessage);
    }

    function setupRealtime() {
        // Escuta INSERTS (novas msgs) e UPDATES (msgs apagadas)
        supabaseClient.channel('room')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'banco', filter: `sala_id=eq.${currentRoom}`}, 
        payload => {
            renderMessage(payload.new); // Atualiza ou cria
        }).subscribe();
    }
</script>
</body>
  </html> 
