<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>TheZap Ultimate</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  /* CSS GERAL */
  :root{ --bg:#e9f7f2; --top:#075e54; --accent:#25d366; --muted:#6b6b6b; --card-bg:#fff; --input-bg:#f0f0f0; --input-text:#000; --msg-in:#fff; --msg-out:#d9fdd3; --msg-text:#000; --recording:#e53935; }
  body.dark-mode { --bg:#111b21; --top:#202c33; --card-bg:#111b21; --input-bg:#2a3942; --input-text:#e9edef; --msg-in:#202c33; --msg-out:#005c4b; --msg-text:#e9edef; --muted:#8696a0; }
  *{box-sizing:border-box} html,body{height:100%;margin:0;font-family:system-ui,-apple-system,sans-serif;background:var(--bg);transition:background 0.3s;}
  .frame{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:0;} @media(min-width:768px){.frame{padding:8px;}.card{max-width:720px;height:calc(100vh - 16px);border-radius:12px;}}
  .card{width:100%;height:100vh;background:var(--card-bg);display:flex;flex-direction:column;overflow:hidden;}
  
  /* TOPO */
  .topbar{background:var(--top);color:#fff;padding:8px 12px;display:flex;gap:10px;align-items:center;flex-shrink:0;justify-content:space-between;}
  .top-left{display:flex;gap:10px;align-items:center;}
  .brand-logo{width:30px;height:30px;fill:white;}
  .info{display:flex;flex-direction:column;}
  .title{font-weight:700;font-size:15px;}
  .subtitle{font-size:11px;opacity:0.9;}
  .typing-indicator{font-size:11px;color:#25d366;font-weight:bold;display:none;animation:blink 1s infinite;}
  @keyframes blink{50%{opacity:0.5;}}
  
  /* BUSCA */
  .search-box{display:none;width:100%;padding:8px;background:var(--top);}
  .search-box.active{display:block;}
  .search-box input{width:100%;padding:6px;border-radius:5px;border:none;outline:none;}

  /* CHAT */
  .messages-wrap{flex:1;overflow-y:auto;padding:14px;background-color:var(--bg);background-image:url("data:image/svg+xml,%3Csvg width='100' height='100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M50 50L0 100L100 0Z' fill='%23999' fill-opacity='0.05'/%3E%3C/svg%3E");display:flex;flex-direction:column;gap:4px;}
  
  .msg-row{display:flex;gap:8px;margin-bottom:2px;width:100%;}
  .msg-row.me{flex-direction:row-reverse;}
  .chat-avatar{width:30px;height:30px;border-radius:50%;object-fit:cover;margin-top:5px;}
  
  .bubble{max-width:80%;padding:6px 8px;border-radius:8px;background:var(--msg-in);color:var(--msg-text);box-shadow:0 1px 2px rgba(0,0,0,0.1);position:relative;font-size:14px;}
  .bubble.me{background:var(--msg-out);}
  
  /* REPLY STYLE */
  .reply-preview{background:rgba(0,0,0,0.05);border-left:4px solid var(--accent);padding:4px;border-radius:4px;font-size:11px;margin-bottom:4px;cursor:pointer;}
  
  /* REACTIONS */
  .reactions{position:absolute;bottom:-10px;right:10px;background:#fff;border-radius:10px;padding:2px 6px;font-size:10px;box-shadow:0 1px 2px rgba(0,0,0,0.2);display:none;color:#000;}
  .reactions.show{display:block;}

  .bubble-autor{font-size:11px;font-weight:800;color:var(--top);margin-bottom:2px;}
  .bubble.me .bubble-autor{display:none;}
  .bubble-text{white-space:pre-wrap;line-height:1.4;}
  .bubble-img{max-width:100%;border-radius:6px;margin-top:4px;}
  
  .meta{font-size:10px;color:var(--muted);text-align:right;display:flex;align-items:center;justify-content:flex-end;gap:4px;margin-top:2px;}
  .ticks{font-size:14px;} .ticks.blue{color:#34b7f1;}
  
  /* COMPOSER */
  .preview-area{padding:10px;background:var(--card-bg);border-top:1px solid #ddd;display:none;}
  .preview-area img{height:100px;border-radius:8px;}
  .reply-bar{background:var(--input-bg);padding:8px;border-left:4px solid var(--accent);font-size:12px;display:none;justify-content:space-between;align-items:center;color:var(--input-text);}
  
  .composer{padding:6px;background:var(--input-bg);display:flex;gap:6px;align-items:flex-end;}
  textarea{flex:1;min-height:40px;max-height:100px;padding:10px;border-radius:20px;border:none;resize:none;outline:none;background:var(--card-bg);color:var(--input-text);}
  .btn-icon{width:40px;height:40px;border-radius:50%;border:none;display:flex;align-items:center;justify-content:center;cursor:pointer;background:transparent;color:var(--muted);font-size:20px;}
  .btn-send{background:var(--top);color:#fff;}
  .btn-mic.rec{background:var(--recording);color:#fff;animation:pulse 1s infinite;}
  @keyframes pulse{0%{transform:scale(1);}50%{transform:scale(1.1);}100%{transform:scale(1);}}

  /* MENU */
  .dropdown-content{display:none;position:absolute;top:50px;right:10px;background:var(--card-bg);box-shadow:0 5px 15px rgba(0,0,0,0.3);z-index:100;border-radius:8px;min-width:160px;overflow:hidden;}
  .dropdown-content.show{display:block;}
  .dropdown-content button, .dropdown-content a{display:block;width:100%;padding:12px;text-align:left;border:none;background:none;color:var(--input-text);text-decoration:none;font-size:14px;}
  .dropdown-content button:hover{background:rgba(0,0,0,0.05);}

  .hidden{display:none!important;}
</style>
</head>
<body>
  <div class="frame">
    <div class="card">
      <!-- TOPO -->
      <div class="topbar">
        <div class="top-left">
          <svg class="brand-logo" viewBox="0 0 100 100"><path d="M20,20 Q80,10 80,50 Q80,90 50,90 L20,95 L25,75 Q10,60 20,20 Z" fill="#25d366"/><path d="M45,25 L65,25 L50,50 L70,50 L35,80 L45,50 L25,50 Z" fill="white"/></svg>
          <div class="info">
            <div class="title">TheZap</div>
            <div class="subtitle" id="statusText">Conectando...</div>
            <div class="typing-indicator" id="typingInd"></div>
          </div>
        </div>
        <div style="display:flex; gap:10px;">
            <div class="btn-icon" onclick="toggleSearch()">üîç</div>
            <div class="btn-icon" onclick="toggleMenu()">‚ãÆ</div>
        </div>
      </div>
      
      <!-- BUSCA -->
      <div class="search-box" id="searchBox"><input type="text" id="searchInput" placeholder="Buscar mensagem..." onkeyup="filterMessages()"></div>

      <!-- MENU SUSPENSO -->
      <div id="myDropdown" class="dropdown-content">
        <a href="/perfil.html">üë§ Meu Perfil</a>
        <button onclick="toggleDarkMode()">üåô Tema Escuro/Claro</button>
        <button onclick="document.getElementById('wallInput').click()">üñºÔ∏è Papel de Parede</button>
        <a href="/termos.html">üìÑ Termos</a>
        <button onclick="shareApp()">üîó Compartilhar</button>
        <button onclick="logout()" style="color:red;">‚úñ Sair</button>
      </div>
      <input type="file" id="wallInput" hidden accept="image/*">

      <!-- √ÅREA PRINCIPAL -->
      <div class="main">
        <div id="messagesWrap" class="messages-wrap"><div id="mensagens" style="display:flex;flex-direction:column;gap:4px;"></div></div>
        
        <!-- √ÅREA DE PREVIEW -->
        <div id="replyBar" class="reply-bar"><span id="replyText"></span> <button onclick="cancelReply()">‚úñ</button></div>
        <div id="previewArea" class="preview-area"><img id="imgPreview"> <button onclick="cancelImg()">‚úñ</button></div>

        <!-- COMPOSITOR -->
        <div class="composer" id="composerArea">
           <button class="btn-icon" onclick="document.getElementById('fileInput').click()">üìé</button>
           <input type="file" id="fileInput" hidden>
           <textarea id="campoTexto" placeholder="Mensagem..."></textarea>
           <button id="btnMic" class="btn-icon btn-mic">üé§</button>
           <button id="btnEnviar" class="btn-icon btn-send">‚û§</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const SUPABASE_URL = 'https://zlppiyhqlhppbhkurisr.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpscHBpeWhxbGhwcGJoa3VyaXNyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4NjA0MzYsImV4cCI6MjA3OTQzNjQzNn0.ybVSaBl18pz8OQbtL65Fqn3dIQ4H8qd4OuGRp6ngFnI';
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const el={msgDiv:document.getElementById('mensagens'),wrap:document.getElementById('messagesWrap'),txt:document.getElementById('campoTexto'),replyBar:document.getElementById('replyBar'),replyTxt:document.getElementById('replyText'),preview:document.getElementById('previewArea'),imgPrev:document.getElementById('imgPreview'),fileIn:document.getElementById('fileInput'),mic:document.getElementById('btnMic'),send:document.getElementById('btnEnviar'),status:document.getElementById('statusText'),typing:document.getElementById('typingInd')};
    
    let currentUser=null, replyTo=null, fileToSend=null, mediaRecorder=null, audioChunks=[], isRec=false, channel=null;
    
    if(localStorage.getItem('theme')==='dark') document.body.classList.add('dark-mode');
    if(localStorage.getItem('wall')) el.wrap.style.backgroundImage=`url(${localStorage.getItem('wall')})`;
    
    async function init() {
        const {data} = await supabase.auth.getSession();
        if(!data.session) return window.location.href = '/perfil.html';
        currentUser = data.session.user;
        el.status.textContent = 'Online';
        setupRealtime();
        fetchMessages();
    }
    init();

    function setupRealtime() {
        channel = supabase.channel('room1');
        channel.on('presence', { event: 'sync' }, () => {
            const state = channel.presenceState();
            const typers = Object.values(state).flat().filter(u => u.typing && u.user_id !== currentUser.id);
            el.typing.textContent = typers.length ? `${typers[0].name} digitando...` : '';
            el.typing.style.display = typers.length ? 'block' : 'none';
            el.status.style.display = typers.length ? 'none' : 'block';
        })
        .on('postgres_changes', { event: '*', schema: 'public', table: 'banco' }, payload => {
            if(payload.eventType === 'INSERT') appendMessage(payload.new);
            if(payload.eventType === 'UPDATE') updateMessage(payload.new);
            if(payload.eventType === 'DELETE') document.getElementById(`msg-${payload.old.id}`)?.remove();
            playPop();
        })
        .subscribe(async (status) => {
            if (status === 'SUBSCRIBED') await channel.track({ user_id: currentUser.id, name: currentUser.user_metadata.full_name, typing: false });
        });
    }

    el.txt.addEventListener('input', () => { channel.track({ user_id: currentUser.id, name: currentUser.user_metadata.full_name, typing: el.txt.value.length > 0 }); });

    async function fetchMessages() {
        const { data } = await supabase.from('banco').select('*').order('created_at', { ascending: true }).limit(100);
        el.msgDiv.innerHTML = '';
        data.forEach(appendMessage);
        scrollToBottom();
        data.forEach(msg => { if(msg.user_id !== currentUser.id && !msg.lido) supabase.from('banco').update({lido:true}).eq('id',msg.id).then(); });
    }

    function appendMessage(msg) {
        if(document.getElementById(`msg-${msg.id}`)) return;
        const isMe = msg.user_id === currentUser.id;
        const date = new Date(msg.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        const ticks = msg.lido ? '<span class="ticks blue">‚úì‚úì</span>' : '<span class="ticks">‚úì</span>';
        
        const div = document.createElement('div');
        div.className = `msg-row ${isMe ? 'me' : ''}`;
        div.id = `msg-${msg.id}`;
        div.ondblclick = () => react(msg.id, '‚ù§Ô∏è');

        let content = '';
        if(msg.reply_to) content += `<div class="reply-preview">‚Ü™ ${msg.reply_to.texto || 'M√≠dia'}</div>`;
        if(!isMe) content += `<div class="bubble-autor">${msg.autor_nome}</div>`;
        if(msg.texto) content += `<div class="bubble-text">${msg.texto}</div>`;
        if(msg.url_arquivo) {
            if(msg.url_arquivo.includes('.webm')) content += `<audio controls src="${msg.url_arquivo}"></audio>`;
            else content += `<img src="${msg.url_arquivo}" class="bubble-img" onclick="window.open('${msg.url_arquivo}')">`;
        }
        const reactions = msg.reacoes && Object.keys(msg.reacoes).length ? `<div class="reactions show">‚ù§Ô∏è ${Object.keys(msg.reacoes).length}</div>` : '';
        const trashBtn = isMe ? `<button class="btn-trash" onclick="delMsg(${msg.id})">üóë</button>` : '';
        const replyBtn = `<button class="btn-trash" onclick='setReply(${JSON.stringify(msg)})'>‚Ü©</button>`;

        div.innerHTML = `
            <img class="chat-avatar" src="${msg.autor_avatar || 'https://via.placeholder.com/30'}">
            <div class="bubble ${isMe ? 'me' : ''}">
                ${content}
                <div class="meta">${date} ${isMe ? ticks : ''} ${replyBtn} ${trashBtn}</div>
                ${reactions}
            </div>
        `;
        el.msgDiv.appendChild(div);
        scrollToBottom();
    }

    async function sendMessage() {
        const text = el.txt.value.trim();
        if(!text && !fileToSend) return;
        el.send.disabled = true;
        let url = null;
        if(fileToSend) {
            const name = `${currentUser.id}/${Date.now()}`;
            await supabase.storage.from('arquivos').upload(name, fileToSend);
            url = supabase.storage.from('arquivos').getPublicUrl(name).data.publicUrl;
        }
        await supabase.from('banco').insert([{
            texto: text, url_arquivo: url, user_id: currentUser.id,
            autor_nome: currentUser.user_metadata.full_name,
            autor_avatar: currentUser.user_metadata.avatar_url,
            reply_to: replyTo ? { id: replyTo.id, texto: replyTo.texto || 'M√≠dia' } : null
        }]);
        el.txt.value = ''; cancelImg(); cancelReply(); el.send.disabled = false; playSwoosh();
    }

    window.setReply = (msg) => { replyTo = msg; el.replyBar.style.display='flex'; el.replyTxt.textContent = `Resp: ${msg.autor_nome}`; el.txt.focus(); };
    window.cancelReply = () => { replyTo = null; el.replyBar.style.display='none'; };
    window.delMsg = async (id) => { if(confirm('Apagar?')) await supabase.from('banco').delete().eq('id', id); };
    window.react = async (id, emoji) => {
        const {data} = await supabase.from('banco').select('reacoes').eq('id',id).single();
        let r = data.reacoes || {}; r[currentUser.id] = emoji;
        await supabase.from('banco').update({reacoes: r}).eq('id', id);
    };
    function updateMessage(msg) { const old = document.getElementById(`msg-${msg.id}`); if(old) { old.outerHTML = ''; appendMessage(msg); } }

    el.fileIn.onchange = e => { fileToSend=e.target.files[0]; if(fileToSend){el.preview.style.display='block'; el.imgPrev.src=URL.createObjectURL(fileToSend);} };
    window.cancelImg = () => { fileToSend=null; el.fileIn.value=''; el.preview.style.display='none'; };
    window.toggleMenu = () => document.getElementById('myDropdown').classList.toggle('show');
    window.toggleSearch = () => { document.getElementById('searchBox').classList.toggle('active'); document.getElementById('searchInput').focus(); };
    window.filterMessages = () => { const term = document.getElementById('searchInput').value.toLowerCase(); document.querySelectorAll('.msg-row').forEach(row => { row.style.display = row.textContent.toLowerCase().includes(term) ? 'flex' : 'none'; }); };
    window.toggleDarkMode = () => { document.body.classList.toggle('dark-mode'); localStorage.setItem('theme', document.body.classList.contains('dark-mode')?'dark':'light'); toggleMenu(); };
    document.getElementById('wallInput').onchange = e => { const f = e.target.files[0]; if(!f)return; const r = new FileReader(); r.onload=ev=>{ el.wrap.style.backgroundImage=`url(${ev.target.result})`; localStorage.setItem('wall', ev.target.result); }; r.readAsDataURL(f); toggleMenu(); };
    window.logout = async () => { await supabase.auth.signOut(); window.location.href='/perfil.html'; };
    window.shareApp = async () => { if(navigator.share) await navigator.share({url:window.location.href}); else alert(window.location.href); };
    function scrollToBottom(){ setTimeout(()=>el.wrap.scrollTop=el.wrap.scrollHeight, 100); }
    
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    function playPop() { if(ctx.state === 'suspended') ctx.resume(); const o=ctx.createOscillator(), g=ctx.createGain(); o.connect(g); g.connect(ctx.destination); o.frequency.value=800; g.gain.exponentialRampToValueAtTime(0.00001, ctx.currentTime+0.1); o.start(); o.stop(ctx.currentTime+0.1); }
    function playSwoosh() { if(ctx.state === 'suspended') ctx.resume(); const o=ctx.createOscillator(), g=ctx.createGain(); o.connect(g); g.connect(ctx.destination); o.type='triangle'; o.frequency.setValueAtTime(300, ctx.currentTime); o.frequency.exponentialRampToValueAtTime(600, ctx.currentTime+0.2); g.gain.exponentialRampToValueAtTime(0.00001, ctx.currentTime+0.2); o.start(); o.stop(ctx.currentTime+0.2); }

    el.mic.onclick=async()=>{if(!isRec){try{const s=await navigator.mediaDevices.getUserMedia({audio:true});mediaRecorder=new MediaRecorder(s);audioChunks=[];mediaRecorder.ondataavailable=e=>audioChunks.push(e.data);mediaRecorder.onstop=async()=>{let b=new Blob(audioChunks,{type:'audio/webm'});fileToSend=b;sendMessage();fileToSend=null;};mediaRecorder.start();isRec=true;el.mic.classList.add('rec');}catch(e){alert(e)}}else{mediaRecorder.stop();isRec=false;el.mic.classList.remove('rec');}};
    el.send.onclick = sendMessage; el.txt.onkeydown = e => { if(e.key==='Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } };
  </script>
</body>
</html>
