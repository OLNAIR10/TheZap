  <script>
    const SUPABASE_URL = 'https://zlppiyhqlhppbhkurisr.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpscHBpeWhxbGhwcGJoa3VyaXNyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4NjA0MzYsImV4cCI6MjA3OTQzNjQzNn0.ybVSaBl18pz8OQbtL65Fqn3dIQ4H8qd4OuGRp6ngFnI';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const ADMIN_EMAILS = ['olnair10pereira@gmail.com']; 
    const MAX_IMAGE_WIDTH = 1200; // M√°ximo de largura para redimensionamento de imagens (em px)

    const el={
        authPanel: document.getElementById('authPanel'), mainAppArea: document.getElementById('mainAppArea'),
        msgDiv:document.getElementById('mensagens'),wrap:document.getElementById('messagesWrap'),txt:document.getElementById('campoTexto'),replyBar:document.getElementById('replyBar'),replyTxt:document.getElementById('replyText'),preview:document.getElementById('previewArea'),imgPrev:document.getElementById('imgPreview'),fileIn:document.getElementById('fileInput'),mic:document.getElementById('btnMic'),send:document.getElementById('btnEnviar'),status:document.getElementById('statusText'),typing:document.getElementById('typingInd'), selBar:document.getElementById('selectionBar'), selCount:document.getElementById('selCount'),
        email: document.getElementById('email'), pass: document.getElementById('password'), btnLogin: document.getElementById('btnLogin'), btnSignup: document.getElementById('btnSignup'), btnTogglePass: document.getElementById('btnTogglePass'),
        linkForgot: document.getElementById('linkForgot'), recoveryPanel: document.getElementById('recoveryPanel'), loginForm: document.getElementById('loginForm'), emailRecovery: document.getElementById('emailRecovery'), btnSendRecovery: document.getElementById('btnSendRecovery'), btnBackLogin: document.getElementById('btnBackLogin'), recStatus: document.getElementById('recStatus'), recTimer: document.getElementById('recTimer'), topBar: document.getElementById('topBar'),
    };
    
    let currentUser=null, replyTo=null, fileToSend=null, mediaRecorder=null, audioChunks=[], isRec=false, channel=null, recStartTime=null, recInterval=null;
    let selectionMode = false, selectedIds = new Set(), longPressTimer;
    let isUploading = false; // NOVA FLAG para evitar envio duplo e travas

    if(localStorage.getItem('theme')==='dark') document.body.classList.add('dark-mode');
    if(localStorage.getItem('wall')) el.wrap.style.backgroundImage=`url(${localStorage.getItem('wall')})`;

    // --- UTILS E UI ---

    function setInterfaceEnabled(enabled) {
        el.txt.disabled = !enabled;
        el.send.disabled = !enabled;
        el.mic.disabled = !enabled;
        // Se estiver desabilitado, mostra o feedback de carregamento
        if (!enabled) {
             el.topBar.style.opacity = 0.7; 
             el.status.textContent = "Processando...";
        } else {
             el.topBar.style.opacity = 1;
             el.status.textContent = 'Online';
        }
    }
    
    // Helper para formatar o tempo (00:00)
    function formatTime(seconds) {
        const min = Math.floor(seconds / 60);
        const sec = Math.floor(seconds % 60);
        return `${min.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`;
    }

    // --- AUTENTICA√á√ÉO E INICIALIZA√á√ÉO ---

    async function init() {
        const {data} = await supabaseClient.auth.getSession();
        if(data.session) {
            currentUser = data.session.user;
            el.authPanel.classList.add('hidden');
            el.mainAppArea.classList.remove('hidden');
            el.status.textContent = 'Online';
            setupRealtime();
            fetchMessages();
        } else {
            el.authPanel.classList.remove('hidden');
            el.mainAppArea.classList.add('hidden');
            el.status.textContent = 'Desconectado';
        }
    }
    init();

    // AUTH (mantido o c√≥digo anterior)
    async function handleLogin(){ const e=el.email.value,p=el.pass.value; if(!e||!p) return alert('Preencha tudo'); el.btnLogin.textContent='...'; const{error}=await supabaseClient.auth.signInWithPassword({email:e,password:p}); el.btnLogin.textContent='ENTRAR'; if(error) alert(error.message); else init(); }
    async function handleSignup(){ const e=el.email.value,p=el.pass.value; if(!e||!p) return alert('Preencha tudo'); el.btnSignup.textContent='...'; const{error}=await supabaseClient.auth.signUp({email:e,password:p}); el.btnSignup.textContent='CADASTRAR'; if(error) alert(error.message); else alert('Cadastro realizado!'); }
    el.btnLogin.onclick = handleLogin; el.btnSignup.onclick = handleSignup;
    el.btnTogglePass.onclick = () => { const type = el.pass.getAttribute('type') === 'password' ? 'text' : 'password'; el.pass.setAttribute('type', type); };
    el.linkForgot.onclick = () => { el.loginForm.classList.add('hidden'); el.recoveryPanel.classList.remove('hidden'); };
    el.btnBackLogin.onclick = () => { el.recoveryPanel.classList.add('hidden'); el.loginForm.classList.remove('hidden'); };
    el.btnSendRecovery.onclick = async () => { if(!el.emailRecovery.value) return alert('Digite seu e-mail'); await supabaseClient.auth.resetPasswordForEmail(el.emailRecovery.value, {redirectTo: window.location.href}); alert('Link enviado!'); };

    // --- OTIMIZA√á√ÉO DE UPLOAD E REDIMENSIONAMENTO ---

    /**
     * Redimensiona uma imagem (Blob) usando Canvas e retorna um novo Blob JPG.
     * Isso reduz o tamanho do arquivo ANTES do upload, otimizando a velocidade.
     * @param {File} file O arquivo de imagem original.
     * @param {number} maxWidth Largura m√°xima desejada.
     * @returns {Promise<Blob>} O Blob redimensionado.
     */
    function resizeImageAndUpload(file, maxWidth) {
        return new Promise((resolve) => {
            const img = new Image();
            const reader = new FileReader();

            reader.onload = (e) => {
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    let width = img.width;
                    let height = img.height;

                    // Ajusta as dimens√µes
                    if (width > maxWidth) {
                        height = Math.round((height * maxWidth) / width);
                        width = maxWidth;
                    }

                    canvas.width = width;
                    canvas.height = height;
                    
                    // Desenha a imagem no novo tamanho
                    ctx.drawImage(img, 0, 0, width, height);

                    // Converte para Blob (JPEG para melhor compress√£o e tamanho padr√£o)
                    canvas.toBlob((blob) => {
                        resolve(blob);
                    }, 'image/jpeg', 0.8); // 0.8 √© a qualidade de compress√£o
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        });
    }

    async function handleFileUpload(e) {
        let file = e.target.files[0];
        if (!file) return;

        fileToSend = file;

        // OTIMIZA√á√ÉO: Redimensiona imagens antes de mostrar o preview e anexar
        if (file.type.startsWith('image/')) {
            el.status.textContent = "Processando imagem...";
            setInterfaceEnabled(false);
            
            try {
                const resizedBlob = await resizeImageAndUpload(file, MAX_IMAGE_WIDTH);
                
                // Substitui o arquivo original pelo redimensionado
                fileToSend = new File([resizedBlob], file.name, { type: 'image/jpeg' });
            } catch (error) {
                console.error("Erro no redimensionamento: ", error);
                alert("Erro ao processar imagem. Tentando enviar original.");
            } finally {
                setInterfaceEnabled(true);
            }
        }
        // V√çDEO/√ÅUDIO: (Manter o original, mas mostrar preview para UX)
        // Para v√≠deos, a compress√£o teria que ser feita com bibliotecas complexas (ex: FFmpeg.js), 
        // o que n√£o √© vi√°vel em c√≥digo puramente JavaScript. A otimiza√ß√£o se limita √† compress√£o nativa de upload.

        // OTIMIZA√á√ÉO: Optimistic UI para Preview
        el.preview.style.display = 'flex';
        el.imgPrev.src = URL.createObjectURL(fileToSend); 
    }

    el.fileIn.onchange = handleFileUpload;

    // --- CHAT LOGIC --- (Fun√ß√µes principais refatoradas)
    
    function setupRealtime() {
        if(channel) return;
        channel = supabaseClient.channel('room1');
        channel.on('presence', { event: 'sync' }, () => {
            const state = channel.presenceState();
            const typers = Object.values(state).flat().filter(u => u.typing && u.user_id !== currentUser.id);
            el.typing.textContent = typers.length ? `${typers[0].name} digitando...` : '';
            el.typing.style.display = typers.length ? 'block' : 'none';
            el.status.style.display = typers.length ? 'none' : 'block';
        })
        .on('postgres_changes', { event: '*', schema: 'public', table: 'banco' }, payload => {
            if(payload.eventType === 'INSERT') appendMessage(payload.new);
            if(payload.eventType === 'UPDATE') updateMessage(payload.new);
            if(payload.eventType === 'DELETE') removeMessageFromScreen(payload.old.id);
            playPop();
        })
        .subscribe(async (status) => {
            if (status === 'SUBSCRIBED') await channel.track({ user_id: currentUser.id, name: currentUser.user_metadata.full_name, typing: false });
        });
    }

    el.txt.addEventListener('input', () => { channel.track({ user_id: currentUser.id, name: currentUser.user_metadata.full_name, typing: el.txt.value.length > 0 }); });

    async function fetchMessages() {
        const { data } = await supabaseClient.from('banco').select('*').order('created_at', { ascending: true }).limit(100);
        el.msgDiv.innerHTML = '';
        data.forEach(appendMessage);
        scrollToBottom();
        data.forEach(msg => { if(msg.user_id !== currentUser.id && !msg.lido) supabaseClient.from('banco').update({lido:true}).eq('id',msg.id).then(); });
    }
    
    function appendMessage(msg) {
        if(document.getElementById(`msg-${msg.id}`)) return;
        
        // CORRE√á√ÉO: Ignora mensagens locais (pending) se elas j√° foram enviadas pelo Realtime
        if (msg.local && document.getElementById(`msg-${msg.id.replace('local-', '')}`)) return; 
        
        const isMe = msg.user_id === currentUser.id;
        const isAdmin = ADMIN_EMAILS.includes(currentUser.email);
        const date = new Date(msg.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        const ticks = msg.lido ? '<span class="ticks blue">‚úì‚úì</span>' : '<span class="ticks">‚úì</span>';
        
        const div = document.createElement('div');
        div.className = `msg-row ${isMe ? 'me' : ''}`;
        div.id = `msg-${msg.id}`;
        
        // Adiciona evento de clique e sele√ß√£o (mantido o c√≥digo anterior)
        div.addEventListener('touchstart', () => startLongPress(msg.id));
        div.addEventListener('touchend', () => cancelLongPress());
        div.addEventListener('mousedown', () => startLongPress(msg.id));
        div.addEventListener('mouseup', () => cancelLongPress());
        div.addEventListener('click', (e) => handleClick(msg, e));

        let content = '';
        if(msg.reply_to) content += `<div class="reply-preview">‚Ü™ ${msg.reply_to.texto || 'M√≠dia'}</div>`;
        if(!isMe) content += `<div class="bubble-autor">${msg.autor_nome}</div>`;
        if(msg.texto) content += `<div class="bubble-text">${msg.texto}</div>`;
        
        // M√çDIA REVISADA (V√≠deo, Imagem e √Åudio)
        if(msg.url_arquivo) {
            if(msg.url_arquivo.includes('.webm') || msg.url_arquivo.includes('audio/')) {
                // √ÅUDIO
                content += `
                <div class="audio-custom" onclick="playAudio(this, event)">
                    <audio src="${msg.url_arquivo}"></audio>
                    <div class="audio-icon">üîä</div>
                    <div class="audio-txt">Ouvir √Åudio</div>
                    <div class="audio-time" data-duration="loading">00:00</div>
                </div>`;
            } else if (msg.url_arquivo.includes('.mp4') || msg.url_arquivo.includes('video/')) {
                // V√çDEO (NOVO TRATAMENTO)
                 content += `<video src="${msg.url_arquivo}" controls class="bubble-img" style="max-height: 250px;"></video>`;
            } else {
                // IMAGEM
                content += `<img src="${msg.url_arquivo}" class="bubble-img" onclick="if(!selectionMode) window.open('${msg.url_arquivo}')">`;
            }
        }
        
        // OTIMIZA√á√ÉO: Feedback Visual para Uploads Pendentes
        let statusIcon = isMe ? ticks : '';
        if (msg.local) {
             statusIcon = '<span class="ticks" style="color:var(--status-pending, #888);">üïí</span>';
        }


        const reactions = msg.reacoes && Object.keys(msg.reacoes).length ? `<div class="reactions show">‚ù§Ô∏è ${Object.keys(msg.reacoes).length}</div>` : '';
        const trashBtn = (isMe || isAdmin) ? `<span class="msg-actions"><button class="btn-trash" onclick="delMsg(${msg.id})">üóë</button></span>` : '';
        const replyBtn = `<span class="msg-actions"><button class="btn-trash" onclick='setReply(${JSON.stringify(msg)})'>‚Ü©</button></span>`;

        div.innerHTML = `
            <img class="chat-avatar" src="${msg.autor_avatar || 'https://via.placeholder.com/30'}">
            <div class="bubble ${isMe ? 'me' : ''} ${msg.local ? 'pending' : ''}">
                ${content}
                <div class="meta">${date} ${statusIcon} ${replyBtn} ${trashBtn}</div>
                ${reactions}
            </div>
        `;
        el.msgDiv.appendChild(div);
        scrollToBottom();

        // Otimiza√ß√£o: Carregar metadata do √°udio
        if (msg.url_arquivo && (msg.url_arquivo.includes('.webm') || msg.url_arquivo.includes('audio/'))) {
            const audioEl = div.querySelector('audio');
            const timeEl = div.querySelector('.audio-time');
            audioEl.onloadedmetadata = () => {
                const duration = formatTime(audioEl.duration);
                timeEl.textContent = duration;
                timeEl.dataset.duration = duration;
            };
        }
    }

    // L√ìGICA DE √ÅUDIO (mantido o c√≥digo anterior)
    let currentlyPlayingAudio = null;
    window.playAudio = (btn, e) => {
        if (selectionMode) { e.preventDefault(); e.stopPropagation(); return; }

        const audio = btn.querySelector('audio');
        const icon = btn.querySelector('.audio-icon');
        const timeEl = btn.querySelector('.audio-time');

        if (currentlyPlayingAudio && currentlyPlayingAudio !== audio) {
            currentlyPlayingAudio.pause();
            currentlyPlayingAudio.currentTime = 0;
            currentlyPlayingAudio.closest('.audio-custom').querySelector('.audio-icon').textContent = 'üîä';
            currentlyPlayingAudio.closest('.audio-custom').querySelector('.audio-time').textContent = currentlyPlayingAudio.closest('.audio-custom').querySelector('.audio-time').dataset.duration;
        }

        if (audio.paused) {
            audio.play();
            currentlyPlayingAudio = audio;
            icon.textContent = '‚è∏';
        } else {
            audio.pause();
            currentlyPlayingAudio = null;
            icon.textContent = 'üîä';
        }

        audio.ontimeupdate = () => {
            timeEl.textContent = formatTime(audio.currentTime);
        };
        audio.onended = () => {
            audio.currentTime = 0; 
            currentlyPlayingAudio = null;
            icon.textContent = 'üîä';
            timeEl.textContent = timeEl.dataset.duration; 
        };
    };

    // L√ìGICA DE SELE√á√ÉO E DELE√á√ÉO (mantido o c√≥digo anterior)
    function startLongPress(id) { longPressTimer = setTimeout(() => { enterSelectionMode(id); }, 600); }
    function cancelLongPress() { clearTimeout(longPressTimer); }
    function handleClick(msg, e) { if(selectionMode) { toggleSelection(msg.id); } else { if (e.detail === 2) react(msg.id, '‚ù§Ô∏è'); } }
    function enterSelectionMode(id) { if(selectionMode) return; selectionMode = true; el.selBar.classList.add('active'); document.body.classList.add('selection-active'); toggleSelection(id); if(navigator.vibrate) navigator.vibrate(50); }
    function exitSelectionMode() { selectionMode = false; selectedIds.clear(); el.selBar.classList.remove('active'); document.body.classList.remove('selection-active'); document.querySelectorAll('.msg-row').forEach(row => row.classList.remove('selected')); el.selCount.textContent = '0'; }
    function toggleSelection(id) { const row = document.getElementById(`msg-${id}`); if(!row) return; if(selectedIds.has(id)) { selectedIds.delete(id); row.classList.remove('selected'); } else { selectedIds.add(id); row.classList.add('selected'); } el.selCount.textContent = selectedIds.size; if(selectedIds.size === 0) exitSelectionMode(); }
    async function deleteSelectedMessages() { if(selectedIds.size === 0) return; if(!confirm(`Apagar ${selectedIds.size} mensagens para todos?`)) return; 
        
        const idsToDelete = Array.from(selectedIds);
        const { data: msgs, error: fetchError } = await supabaseClient.from('banco').select('url_arquivo').in('id', idsToDelete).limit(idsToDelete.length);
        
        if (msgs) {
            const filesToRemove = msgs.map(m => m.url_arquivo).filter(Boolean).map(url => url.split('/').pop());
            if (filesToRemove.length > 0) {
                await supabaseClient.storage.from('arquivos').remove(filesToRemove);
            }
        }
        
        const { error: deleteError } = await supabaseClient.from('banco').delete().in('id', idsToDelete); 
        
        if(fetchError || deleteError) alert('Erro ao deletar: ' + (fetchError?.message || deleteError.message)); 
        else exitSelectionMode(); 
    }
    function removeMessageFromScreen(id) { const row = document.getElementById(`msg-${id}`); if(row) row.remove(); }
    
    // --- ENVIO DE MENSAGEM OTIMIZADO (Optimistic UI) ---

    async function sendMessage() {
        const text = el.txt.value.trim();
        if(!text && !fileToSend) return;
        if(isUploading) return; // Previne envio duplo
        
        isUploading = true;
        setInterfaceEnabled(false); 
        
        const localId = 'local-' + Date.now();
        let url = null;
        let fileType = fileToSend?.type;

        // OTIMIZA√á√ÉO: 1. Renderiza a bolha local (Optimistic UI) com o arquivo tempor√°rio
        const optimisticMsg = {
            id: localId,
            texto: text, 
            user_id: currentUser.id,
            autor_nome: currentUser.user_metadata.full_name,
            autor_avatar: currentUser.user_metadata.avatar_url,
            created_at: new Date().toISOString(),
            reply_to: replyTo,
            url_arquivo: fileToSend ? URL.createObjectURL(fileToSend) : null,
            local: true
        };
        appendMessage(optimisticMsg);
        
        el.txt.value = ''; 
        cancelImg(); 
        cancelReply(); 

        try {
            // 2. Processa o upload (ass√≠ncrono e potencial gargalo)
            if(fileToSend) {
                const name = `${currentUser.id}/${Date.now()}-${fileToSend.name || 'file.dat'}`;
                const { error: uploadError } = await supabaseClient.storage.from('arquivos').upload(name, fileToSend, { contentType: fileType });
                if (uploadError) throw uploadError;
                
                url = supabaseClient.storage.from('arquivos').getPublicUrl(name).data.publicUrl;
            }

            // 3. Insere no banco
            const { error: insertError } = await supabaseClient.from('banco').insert([{
                texto: text, url_arquivo: url, user_id: currentUser.id,
                autor_nome: currentUser.user_metadata.full_name,
                autor_avatar: currentUser.user_metadata.avatar_url,
                reply_to: replyTo ? { id: replyTo.id, texto: replyTo.texto || 'M√≠dia' } : null
            }]);
            if (insertError) throw insertError;
            
            // Sucesso: O Realtime atualizar√° o status da bolha local (pending -> sent)
            
        } catch (e) {
            console.error("Erro ao enviar mensagem/upload:", e);
            alert("Falha ao enviar: " + e.message);
            // Falha: Marcar a bolha local como falha (ou remover)
            const localDiv = document.getElementById(localId);
            if(localDiv) {
                localDiv.querySelector('.status-icon').innerHTML = '‚ùå';
            }
        } finally {
            isUploading = false;
            setInterfaceEnabled(true); 
            fileToSend = null; 
            playSwoosh();
        }
    }
    
    // --- UI/L√ìGICA ADICIONAL ---
    
    window.setReply = (msg) => { replyTo = msg; el.replyBar.style.display='flex'; el.replyTxt.textContent = `Resp: ${msg.autor_nome}`; el.txt.focus(); };
    window.cancelReply = () => { replyTo = null; el.replyBar.style.display='none'; };
    window.cancelImg = () => { fileToSend=null; el.fileIn.value=''; el.preview.style.display='none'; };
    window.toggleMenu = () => document.getElementById('myDropdown').classList.toggle('show');
    window.toggleSearch = () => { document.getElementById('searchBox').classList.toggle('active'); document.getElementById('searchInput').focus(); };
    window.filterMessages = () => { const term = document.getElementById('searchInput').value.toLowerCase(); document.querySelectorAll('.msg-row').forEach(row => { row.style.display = row.textContent.toLowerCase().includes(term) ? 'flex' : 'none'; }); };
    window.toggleDarkMode = () => { document.body.classList.toggle('dark-mode'); localStorage.setItem('theme', document.body.classList.contains('dark-mode')?'dark':'light'); toggleMenu(); };
    document.getElementById('wallInput').onchange = e => { const f = e.target.files[0]; if(!f)return; const r = new FileReader(); r.onload=ev=>{ el.wrap.style.backgroundImage=`url(${ev.target.result})`; localStorage.setItem('wall', ev.target.result); }; r.readAsDataURL(f); toggleMenu(); };
    window.logout = async () => { await supabaseClient.auth.signOut(); window.location.href='/'; };
    window.shareApp = async () => { if(navigator.share) await navigator.share({url:window.location.href}); else alert(window.location.href); };
    function scrollToBottom(){ setTimeout(()=>el.wrap.scrollTop=el.wrap.scrollHeight, 100); }
    
    // Sons
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    function playPop() { if(ctx.state === 'suspended') ctx.resume(); const o=ctx.createOscillator(), g=ctx.createGain(); o.connect(g); g.connect(ctx.destination); o.frequency.value=800; g.gain.exponentialRampToValueAtTime(0.00001, ctx.currentTime+0.1); o.start(); o.stop(ctx.currentTime+0.1); }
    function playSwoosh() { if(ctx.state === 'suspended') ctx.resume(); const o=ctx.createOscillator(), g=ctx.createGain(); o.connect(g); g.connect(ctx.destination); o.type='triangle'; o.frequency.setValueAtTime(300, ctx.currentTime); o.frequency.exponentialRampToValueAtTime(600, ctx.currentTime+0.2); g.gain.exponentialRampToValueAtTime(0.00001, ctx.currentTime+0.2); o.start(); o.stop(ctx.currentTime+0.2); }

    // L√ìGICA DE GRAVA√á√ÉO (Mantenha a vers√£o anterior, pois o send j√° foi refatorado)
    el.mic.onclick = async () => {
        if (!isRec) {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];

                mediaRecorder.ondataavailable = e => {
                    if (e.data.size > 0) audioChunks.push(e.data);
                };

                mediaRecorder.onstop = async () => {
                    clearInterval(recInterval);
                    el.mic.classList.remove('rec');
                    el.recStatus.style.display = 'none';
                    isRec = false;

                    if (audioChunks.length === 0) return; 

                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    fileToSend = audioBlob;
                    
                    // N√£o chama sendMessage diretamente, configura o Optimistic UI Preview e chama send.
                    el.preview.style.display = 'flex';
                    el.imgPrev.src = URL.createObjectURL(fileToSend); 
                    sendMessage(); 
                    
                    stream.getTracks().forEach(track => track.stop());
                };
                
                recStartTime = Date.now();
                el.recTimer.textContent = '00:00';
                recInterval = setInterval(() => {
                    const elapsed = Math.round((Date.now() - recStartTime) / 1000);
                    el.recTimer.textContent = formatTime(elapsed);
                }, 1000);

                mediaRecorder.start();
                isRec = true;
                el.mic.classList.add('rec');
                el.recStatus.style.display = 'flex';

            } catch (e) {
                console.error("Erro ao acessar microfone:", e);
                alert("Erro ao iniciar grava√ß√£o. Permita o acesso ao microfone.");
            }
        } else {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop(); 
            }
        }
    };
    
    el.send.onclick = sendMessage; 
    el.txt.onkeydown = e => { if(e.key==='Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } };
  </script>
