<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Perfil - TheZap</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  :root{ --top:#075e54; --bg:#e9f7f2; --white:#fff; --danger:#d32f2f; }
  body { font-family: sans-serif; margin: 0; padding: 0; background: var(--bg); display: flex; flex-direction: column; height: 100vh; }
  
  /* TOPO */
  .header { background: var(--top); color: var(--white); padding: 20px; text-align: center; font-weight: bold; font-size: 18px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
  
  /* CONTAINER CENTRAL */
  .container { flex: 1; display: flex; flex-direction: column; padding: 20px; gap: 15px; max-width: 500px; margin: 0 auto; width: 100%; box-sizing: border-box; }
  
  /* CARD DE USU√ÅRIO */
  .user-card { background: var(--white); padding: 20px; border-radius: 10px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
  .avatar { width: 100px; height: 100px; border-radius: 50%; border: 4px solid var(--top); object-fit: cover; margin-bottom: 10px; cursor: pointer; transition: opacity 0.2s;}
  .avatar:hover { opacity: 0.8; }
  .user-name { font-size: 20px; font-weight: bold; color: #333; margin-bottom: 5px; }
  .user-email { font-size: 14px; color: #666; word-break: break-all; }
  .hint { font-size: 11px; color: #999; margin-top: 5px; }
  
  /* BOT√ïES MENU */
  .menu-btn { 
    background: var(--white); color: #333; padding: 15px; border-radius: 8px; 
    text-decoration: none; font-weight: bold; display: flex; justify-content: space-between; align-items: center;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1); transition: transform 0.1s; cursor: pointer;
  }
  .menu-btn:active { transform: scale(0.98); background: #f5f5f5; }
  .menu-btn span { display: flex; align-items: center; gap: 10px; }
  
  /* BOT√ÉO ENCERRAR */
  .btn-encerrar { 
    background: var(--danger); color: white; text-align: center; padding: 15px; 
    border-radius: 8px; font-weight: bold; margin-top: auto; cursor: pointer; border: none; width: 100%; font-size: 16px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
  }
  .btn-encerrar:active { opacity: 0.8; }

</style>
</head>
<body>

<div class="header">Painel de Perfil</div>

<div class="container">
    
    <!-- CARD DO USU√ÅRIO -->
    <div class="user-card">
        <img id="avatarImg" class="avatar" src="https://via.placeholder.com/100" onclick="document.getElementById('fileInput').click()">
        <div class="hint">(Toque na foto para alterar)</div>
        <div id="userName" class="user-name">Carregando...</div>
        <div id="userEmail" class="user-email">...</div>
        <!-- Input invis√≠vel para upload -->
        <input type="file" id="fileInput" hidden accept="image/*">
    </div>

    <!-- MENU DE OP√á√ïES -->
    <a href="/" class="menu-btn">
        <span>üí¨ Voltar ao Chat</span> <span>‚û§</span>
    </a>

    <div class="menu-btn" onclick="editName()">
        <span>‚úèÔ∏è Alterar Nome</span> <span>‚û§</span>
    </div>

    <a href="/termos.html" class="menu-btn">
        <span>üìÑ Termos e Privacidade</span> <span>‚û§</span>
    </a>

    <a href="https://wa.me/?text=Ol√°, vim pelo TheZap!" class="menu-btn">
        <span>üì¢ Suporte / Anunciar</span> <span>‚û§</span>
    </a>

    <!-- BOT√ÉO SAIR -->
    <button onclick="logout()" class="btn-encerrar">Encerrar Conta (Sair)</button>

</div>

<script>
    // CONFIGURA√á√ÉO SUPABASE
    const SUPABASE_URL = 'https://zlppiyhqlhppbhkurisr.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpscHBpeWhxbGhwcGJoa3VyaXNyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4NjA0MzYsImV4cCI6MjA3OTQzNjQzNn0.ybVSaBl18pz8OQbtL65Fqn3dIQ4H8qd4OuGRp6ngFnI';
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let currentUser = null;

    // INICIAR
    async function init() {
        const { data } = await supabase.auth.getSession();
        if (!data.session) {
            // Se n√£o tiver logado, manda pro in√≠cio
            window.location.href = '/'; 
            return;
        }
        
        currentUser = data.session.user;
        
        // Preenche dados na tela
        document.getElementById('userName').textContent = currentUser.user_metadata.full_name || 'Sem Nome';
        document.getElementById('userEmail').textContent = currentUser.email;
        
        if (currentUser.user_metadata.avatar_url) {
            document.getElementById('avatarImg').src = currentUser.user_metadata.avatar_url;
        }
    }
    init();

    // FUN√á√ÉO 1: ALTERAR NOME
    async function editName() {
        const novoNome = prompt("Digite seu novo nome p√∫blico:", currentUser.user_metadata.full_name);
        if (novoNome && novoNome.trim() !== "") {
            document.getElementById('userName').textContent = "Salvando...";
            const { error } = await supabase.auth.updateUser({
                data: { full_name: novoNome }
            });
            
            if (error) {
                alert("Erro ao salvar nome.");
                init(); // Recarrega dados antigos
            } else {
                init(); // Atualiza tela
            }
        }
    }

    // FUN√á√ÉO 2: TROCAR FOTO
    const fileInput = document.getElementById('fileInput');
    fileInput.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const img = document.getElementById('avatarImg');
        img.style.opacity = '0.5'; // Efeito visual de carregando

        try {
            const fileName = `avatars/${currentUser.id}_${Date.now()}`;
            
            // Upload
            const { error: uploadError } = await supabase.storage.from('arquivos').upload(fileName, file);
            if (uploadError) throw uploadError;

            // Pegar Link
            const { data } = supabase.storage.from('arquivos').getPublicUrl(fileName);
            const publicUrl = data.publicUrl;

            // Atualizar Perfil
            const { error: updateError } = await supabase.auth.updateUser({
                data: { avatar_url: publicUrl }
            });
            if (updateError) throw updateError;

            // Sucesso
            img.src = publicUrl;
            
        } catch (error) {
            alert("Erro ao atualizar foto: " + error.message);
        } finally {
            img.style.opacity = '1';
        }
    };

    // FUN√á√ÉO 3: SAIR (LOGOUT)
    async function logout() {
        if(confirm("Tem certeza que deseja sair?")) {
            await supabase.auth.signOut();
            window.location.href = '/';
        }
    }
</script>

</body>
  </html>
