<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Perfil - TheZap</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  /* VARI√ÅVEIS DE TEMA */
  :root { 
    --top:#075e54; 
    --bg:#e9f7f2; 
    --white:#fff; 
    --card-bg: var(--white);
    --text:#333;
    --muted:#666;
    --danger:#d32f2f;
    --shadow: 0 2px 5px rgba(0,0,0,0.2);
  }
  body.dark-mode { 
    --top:#202c33; 
    --bg:#111b21; 
    --white:#2a3942; /* Cor de fundo para bot√µes e cards no DM */
    --card-bg: var(--white);
    --text:#e9edef;
    --muted:#8696a0;
  }
  
  /* GERAL */
  body { 
    font-family: system-ui, -apple-system, sans-serif; 
    margin: 0; padding: 0; 
    background: var(--bg); 
    display: flex; 
    flex-direction: column; 
    height: 100dvh; 
    color: var(--text);
    transition: background 0.3s, color 0.3s;
  }
  * { box-sizing: border-box; }
  
  /* TOPO */
  .header { 
    background: var(--top); 
    color: white; 
    padding: 20px; 
    text-align: center; 
    font-weight: bold; 
    font-size: 18px; 
    box-shadow: var(--shadow); 
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .header .title { flex: 1; text-align: center; }
  .btn-icon { background: none; border: none; color: white; font-size: 20px; cursor: pointer; padding: 0 5px; }

  /* CONTAINER CENTRAL */
  .container { 
    flex: 1; 
    display: flex; 
    flex-direction: column; 
    padding: 20px; 
    gap: 15px; 
    max-width: 500px; 
    margin: 0 auto; 
    width: 100%; 
    box-sizing: border-box; 
  }
  
  /* CARD DE USU√ÅRIO */
  .user-card { 
    background: var(--card-bg); 
    padding: 20px; 
    border-radius: 10px; 
    text-align: center; 
    box-shadow: 0 2px 5px rgba(0,0,0,0.1); 
    transition: background 0.3s;
  }
  .avatar-wrap { position: relative; display: inline-block; }
  .avatar { 
    width: 100px; height: 100px; 
    border-radius: 50%; 
    border: 4px solid var(--top); 
    object-fit: cover; 
    margin-bottom: 10px; 
    cursor: pointer; 
    transition: opacity 0.2s;
  }
  .avatar:hover { opacity: 0.8; }
  .avatar-loading {
    position: absolute; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0, 0, 0, 0.4);
    border-radius: 50%;
    display: none;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 14px;
    font-weight: bold;
  }
  .avatar-loading.active { display: flex; }

  .user-name { font-size: 20px; font-weight: bold; color: var(--text); margin-bottom: 5px; }
  .user-email { font-size: 14px; color: var(--muted); word-break: break-all; }
  .hint { font-size: 11px; color: var(--muted); margin-top: 5px; opacity: 0.7; }
  
  /* BOT√ïES MENU */
  .menu-btn { 
    background: var(--card-bg); 
    color: var(--text); 
    padding: 15px; 
    border-radius: 8px; 
    text-decoration: none; 
    font-weight: bold; 
    display: flex; 
    justify-content: space-between; 
    align-items: center;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1); 
    transition: transform 0.1s, background 0.3s; 
    cursor: pointer;
  }
  .menu-btn:active { transform: scale(0.98); background: var(--bg); }
  .menu-btn span { display: flex; align-items: center; gap: 10px; }
  
  /* BOT√ÉO ENCERRAR */
  .btn-encerrar { 
    background: var(--danger); 
    color: white; 
    text-align: center; 
    padding: 15px; 
    border-radius: 8px; 
    font-weight: bold; 
    margin-top: auto; 
    cursor: pointer; 
    border: none; 
    width: 100%; 
    font-size: 16px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    transition: opacity 0.2s, background 0.2s;
  }
  .btn-encerrar:active { opacity: 0.8; }
  .btn-encerrar:disabled { background: #999; cursor: not-allowed; }

</style>
</head>
<body id="body">

<div class="header">
    <a href="/" class="btn-icon">‚¨Ö</a>
    <div class="title">Painel de Perfil</div>
    <button class="btn-icon" onclick="toggleDarkMode()">üåô</button>
</div>

<div class="container">
    
    <div class="user-card">
        <div class="avatar-wrap">
            <img id="avatarImg" class="avatar" src="https://via.placeholder.com/100?text=Foto" onclick="document.getElementById('fileInput').click()">
            <div id="avatarLoading" class="avatar-loading">Upload...</div>
        </div>
        <div class="hint">(Toque na foto para alterar)</div>
        <div id="userName" class="user-name">Carregando...</div>
        <div id="userEmail" class="user-email">...</div>
        <input type="file" id="fileInput" hidden accept="image/*">
    </div>

    <a href="/" class="menu-btn">
        <span>üí¨ Voltar ao Chat Principal</span> <span>‚û§</span>
    </a>

    <div class="menu-btn" onclick="editName()">
        <span>‚úèÔ∏è Alterar Nome P√∫blico</span> <span>‚û§</span>
    </div>

    <a href="/termos.html" class="menu-btn">
        <span>üìÑ Termos e Privacidade</span> <span>‚û§</span>
    </a>

    <a href="https://wa.me/?text=Ol√°, vim pelo TheZap! Quero suporte ou informa√ß√µes sobre parcerias." class="menu-btn" target="_blank">
        <span>üì¢ Suporte / Anunciar</span> <span>‚û§</span>
    </a>

    <button onclick="logout()" class="btn-encerrar" id="btnLogout">Encerrar Conta (Sair)</button>

</div>

<script>
    const SUPABASE_URL = 'https://zlppiyhqlhppbhkurisr.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpscHBpeWhxbGhwcGJoa3VyaXNyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4NjA0MzYsImV4cCI6MjA3OTQzNjQzNn0.ybVSaBl18pz8OQbtL65Fqn3dIQ4H8qd4OuGRp6ngFnI';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const el = {
        userName: document.getElementById('userName'),
        userEmail: document.getElementById('userEmail'),
        avatarImg: document.getElementById('avatarImg'),
        fileInput: document.getElementById('fileInput'),
        avatarLoading: document.getElementById('avatarLoading'),
        btnLogout: document.getElementById('btnLogout')
    };

    let currentUser = null;

    // --- UTILS ---

    function toggleDarkMode() {
        const isDark = document.body.classList.toggle('dark-mode');
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
    }
    
    // --- INICIALIZA√á√ÉO ---

    async function init() {
        // Aplica o tema salvo
        if(localStorage.getItem('theme') === 'dark') document.body.classList.add('dark-mode');

        try {
            const { data } = await supabaseClient.auth.getSession();
            
            if (!data.session) {
                window.location.href = '/'; 
                return;
            }
            
            currentUser = data.session.user;
            
            // Preenche dados na tela
            el.userName.textContent = currentUser.user_metadata.full_name || 'Sem Nome P√∫blico';
            el.userEmail.textContent = currentUser.email;
            
            if (currentUser.user_metadata.avatar_url) {
                el.avatarImg.src = currentUser.user_metadata.avatar_url;
            }

        } catch (e) {
            console.error("Erro na inicializa√ß√£o:", e);
            alert("Falha ao carregar a sess√£o. Redirecionando...");
            window.location.href = '/';
        }
    }
    init();

    // --- FUN√á√ïES DE A√á√ÉO ---

    // FUN√á√ÉO 1: ALTERAR NOME
    async function editName() {
        const currentName = currentUser.user_metadata.full_name || '';
        const novoNome = prompt("Digite seu novo nome p√∫blico:", currentName);
        
        if (novoNome && novoNome.trim() !== "" && novoNome.trim() !== currentName) {
            el.userName.textContent = "Salvando...";
            
            try {
                const { error } = await supabaseClient.auth.updateUser({
                    data: { full_name: novoNome.trim() }
                });
                
                if (error) throw error;
                
                // Sucesso: Re-inicializa para carregar os metadados atualizados do usu√°rio
                await init(); 

            } catch (error) {
                alert("Erro ao salvar nome: " + error.message);
                init(); // Recarrega dados antigos em caso de falha
            }
        }
    }

    // FUN√á√ÉO 2: TROCAR FOTO
    el.fileInput.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        el.avatarLoading.classList.add('active'); // Mostra indicador de upload
        
        try {
            const extension = file.name.split('.').pop();
            const fileName = `avatars/${currentUser.id}_${Date.now()}.${extension}`;
            
            // 1. Upload
            const { error: uploadError } = await supabaseClient.storage.from('arquivos').upload(fileName, file, { 
                cacheControl: '3600', 
                upsert: false // N√£o substitui (cria novo)
            });
            if (uploadError) throw uploadError;

            // 2. Pegar Link
            const { data: publicUrlData } = supabaseClient.storage.from('arquivos').getPublicUrl(fileName);
            const publicUrl = publicUrlData.publicUrl;

            // 3. Atualizar Perfil no Auth
            const { error: updateError } = await supabaseClient.auth.updateUser({
                data: { avatar_url: publicUrl }
            });
            if (updateError) throw updateError;

            // 4. Sucesso (Atualiza visualmente)
            el.avatarImg.src = publicUrl;
            
        } catch (error) {
            console.error("Erro ao atualizar foto:", error);
            alert("Erro ao atualizar foto: " + error.message);
        } finally {
            el.avatarLoading.classList.remove('active'); // Esconde indicador
            el.fileInput.value = ''; // Limpa o input
        }
    };

    // FUN√á√ÉO 3: SAIR (LOGOUT)
    async function logout() {
        if(confirm("Tem certeza que deseja encerrar a conta e sair?")) {
            el.btnLogout.textContent = 'Saindo...';
            el.btnLogout.disabled = true;
            try {
                await supabaseClient.auth.signOut();
                window.location.href = '/';
            } catch(e) {
                alert("Erro ao desconectar. Tente novamente.");
                el.btnLogout.textContent = 'Encerrar Conta (Sair)';
                el.btnLogout.disabled = false;
            }
        }
    }
    
</script>

</body>
</html>
