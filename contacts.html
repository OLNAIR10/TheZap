

<!DOCTYPE html>

<html lang="pt-BR">

<head>

<meta charset="utf-8">

<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Contatos On-line</title>


<script src="¬†https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2¬†"></script>


<style>

/* Estilos baseados no WhatsApp para celular */

:root{ --bg:#e5ddd5; --panel:#fff; --my:#dcf8c6; --accent:#25d366; --header:#075e54; --dark:#111; }

corpo{

margem:0;

fundo:var(--bg);

fam√≠lia-da-fonte: Arial, sem serifa;

altura: 100vh;

altura: 100dvh;

exibi√ß√£o:flex;

flex-direction:column;

overflow: oculto;

}

#topbar{ altura:56px; fundo:var(--header); exibi√ß√£o:flex; alinhamento-itens:centro; preenchimento:0 12px; cor:#fff; tamanho-da-fonte:18px; peso-da-fonte:negrito; justificar-conte√∫do: espa√ßo-entre; }

#lista de contatos {

flex: 1;

overflow-y: autom√°tico;

cor de fundo: #fff;

}

.item-de-contato {

Exibir: flex√≠vel;

justify-content: espa√ßo-entre;

alinhamento-itens: centro;

preenchimento: 10px 15px;

borda inferior: 1px s√≥lida #eee;

cursor: ponteiro;

fundo: #fff;

transi√ß√£o: fundo 0,2s;

}

.contact-item:hover {

fundo: #f5f5f5;

}

.informa√ß√µes-de-contato {

flex-grow: 1;

}

.nome-de-contato {

peso da fonte: negrito;

cor: var(--dark);

}

.contact-id {

tamanho da fonte: 12px;

cor: #666;

quebra-de-palavras: quebrar-tudo;

}

.call-btn {

largura: 40px;

altura: 40px;

raio-da-borda: 50%;

fundo: var(--accent);

cor: branca;

fronteira: nenhuma;

tamanho da fonte: 18px;

Exibir: flex√≠vel;

justificar-conte√∫do: centralizado;

alinhamento-itens: centro;

cursor: ponteiro;

box-shadow: 0 2px 4px rgba(0,0,0,0.2);

margem esquerda: 10px;

}

.estado-vazio {

preenchimento: 20px;

alinhamento do texto: centralizado;

cor: #999;

}

#bot√£ovoltar {

cor: branca;

decora√ß√£o de texto: nenhuma;

margem-direita: 15px;

tamanho da fonte: 24px;

}

</style>

</head>

<body>


<div id="topbar">

<a href="index.html" id="backBtn">‚Üê</a>

<span>Contatos Online</span>

</div>


<div id="contactsList">

<div class="empty-state">Carregando usu√°rios...</div>

</div>


<script>

/* ---------- CONFIGURA√á√ÉO SUPABASE (CHAVES UNIFICADAS) ---------- */

// üö® CORRE√á√ÉO: Usando a chave do projeto principal para manter a sess√£o

const SUPABASE_URL = "¬†https://dktkzsmfhhjxkbhvnwnw.supabase.co¬†";

const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRrdGt6c21maGhqeGtiaHZud253Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ5NDQ0MTQsImV4cCI6MjA4MDUyMDQxNH0.QpLkvWSaVPdjszXx0_epadmmfMRjwe_8C7WjcQzNbAs";


const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {

autentica√ß√£o: { persistSess√£o: true }

});


seja usu√°rio = nulo;

const contactsList = document.getElementById('contactsList');


/* ---------- AUTENTICA√á√ÉO E VERIFICA√á√ÉO (CORRIGIDA E ROBUSTA) ---------- */

fun√ß√£o ass√≠ncrona verificarAutentica√ß√£oEInicializa√ß√£o() {

// Tente obter o usu√°rio logado, que √© uma verifica√ß√£o mais confi√°vel.

const { data: { user: loggedUser } } = await sb.auth.getUser();

se (usu√°rio logado) {

usu√°rio = usu√°rio conectado;

buscarUsu√°riosOnline();

subscribeToAuthChanges();

} outro {

// Se n√£o estiver logado, exibe uma mensagem de erro...

contatosList.innerHTML = '<div class="empty-state" style="color:red; font-weight:bold;">Sess√£o n√£o encontrada. Redirecionando para login...</div>';

// ... e espera 1.5s antes de redirecionar para dar tempo de ler a sess√£o.

setTimeout(() => {

window.location.href = 'index.html';

}, 1500);

}

}


/* ---------- REALTIME (Presen√ßa de Usu√°rios) ---------- */

fun√ß√£o subscribeToAuthChanges() {

// Escuta mudan√ßas de autentica√ß√£o (ex: logoff em outra aba)

sb.auth.onAuthStateChange((event, session) => {

se (!sess√£o) {

// Usu√°rio

window.location.href = 'index.html';

}

});

}


/* ---------- CARREGAR USU√ÅRIOS (AJUSTADO PARA USAR 'perfis') ---------- */

fun√ß√£o ass√≠ncrona buscarUsu√°riosOnline() {

// Consulta a tabela 'profiles' (requer RLS de SELECT para 'autenticado')

const { data, error } = await sb.from('profiles')

.select('id, email')

.neq('id',¬†user.id¬†); // Exclui o pr√≥prio usu√°rio


contactsList.innerHTML = '';

se (erro) {

// Mensagem de erro para ajudar no diagn√≥stico de RLS

const mensagemDeErro = error.message.includes('permiss√£o negada')

? 'Erro: As Pol√≠ticas RLS de SELECT na tabela `profiles` n√£o est√£o ativas para "autenticados".'

: `Erro ao enviar contatos: ${error.message}`;

contactsList.innerHTML = `<div class="empty-state" style="color:red; font-weight:bold;">${errorMessage}</div>`;

retornar;

}

se (data.length === 0) {

ContactList.innerHTML = '<div class="empty-state">Nenhum outro usu√°rio registrado para ligar.</div>';

} outro {

dados.forEach(renderContato);

}

}


/* ---------- RENDERIZA√á√ÉO E A√á√ÉO ---------- */

fun√ß√£o renderContato(contato) {

const item = document.createElement('div');

item.className = 'contact-item';

const info = document.createElement('div');

info.className = 'contact-info';

const nome = document.createElement('div');

nome.className = 'nome-do-contato';

name.textContent = contact.email.split('@')[0]; // Usa o prefixo do email

const id = document.createElement('div');

id.className = 'contact-id';

id.textContent = `ID: ${¬†contact.id¬†}`;

info.appendChild(nome);

info.appendChild(id);

item.appendChild(info);

const callBtn = document.createElement('button');

callBtn.className = 'call-btn';

callBtn.innerHTML = ' üìπ'; //√çcone da c√¢mera

callBtn.onclick = (e) => startCall(e,¬†contact.id¬†);

item.appendChild(callBtn);


contactsList.appendChild(item);

}


fun√ß√£o iniciarChamada(e, targetId) {

e.stopPropagation(); // Previne qualquer clique acidental no item

// Redireciona para a p√°gina principal com o ID do alvo na URL para iniciar a chamada.

window.location.href = `index.html?target=${targetId}`;

}


// Torna a fun√ß√£o de chamada global para uso no HTML

janela.iniciarChamada = iniciarChamada;


// Inicia o processo de verifica√ß√£o de autentica√ß√£o

verificarAutentica√ß√£oEInicializa√ß√£o();

</script>


</body>

</html>



