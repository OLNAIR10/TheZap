<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>TheZap Privado + Arquivos</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  /* CSS GERAL */
  :root{ 
    --bg:#e5ddd5; 
    --top:#4a148c; 
    --card-bg:#fff; 
    --input-bg:#f0f0f0; 
    --msg-in:#fff; 
    --msg-out:#e1bee7; 
    --mic-btn: #8050a9; 
    --status-pending: #888; 
    --status-sent: #008000; 
    --text-color: #000;
  }
  
  body { margin:0; font-family:system-ui, -apple-system, sans-serif; background: var(--bg); display:flex; justify-content:center; height: 100dvh; overflow:hidden; }
  
  .card { width:100%; max-width:720px; background:var(--card-bg); display:flex; flex-direction:column; height:100%; position: relative; }
  
  /* TOPO ROXO */
  .topbar { background:var(--top); color:white; padding:10px; display:flex; align-items:center; justify-content:space-between; flex-shrink: 0; box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 10; }
  .btn-back { color:white; text-decoration:none; font-size:24px; margin-right:15px; cursor: pointer; }
  
  /* MENSAGENS */
  .messages-wrap { flex:1; overflow-y:auto; padding:15px; display:flex; flex-direction:column; gap:8px; 
    background-image: url('data:image/jpeg;base64,/9j/4AAQSkZJRgABAQEAYABgAAD/2wBDAAgGBgcGBQgHBwcJCQgKDBQNDAsLDBkSEw8UHRofHh0aHBwgJC4nICIsIxwcKDcpLDAxNDQ0Hyc5PTgyPC4zNDL/2wDAQkJCQwLDBgNDRgyIRwhMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjL/wAARCAAoACgDASIAAhEBAxEB/8QAFQABAQAAAAAAAAAAAAAAAAAAAAD/xAAUEAEAAAAAAAAAAAAAAAAAAAAA/8QAFQEBAQAAAAAAAAAAAAAAAAAAAAT/xAAUEAEAAAAAAAAAAAAAAAAAAAAA/9oADAMBAAIRAPwArAAAAAAAAAAAP/Z');
    background-repeat: repeat; 
    background-color: #e5ddd5; 
  }
  
  .bubble { 
    max-width:80%; 
    padding:8px 12px; 
    border-radius:8px; 
    background:var(--msg-in); 
    align-self:flex-start; 
    font-size:15px; 
    box-shadow:0 1px 2px rgba(0,0,0,0.1); 
    color: var(--text-color); 
    position: relative;
    opacity: 1;
    white-space: pre-wrap;
    word-break: break-word; /* Para quebrar links longos */
  }
  .bubble.me { background:var(--msg-out); align-self:flex-end; }
  .bubble.pending { opacity: 0.6; }
  
  .bubble-autor { font-size:11px; font-weight:bold; color:var(--top); margin-bottom:2px; }
  .meta { font-size:10px; color:#555; text-align:right; margin-top: 3px; display: block; }
  .status-icon { margin-left: 5px; color: var(--status-pending); font-weight: normal; }

  /* M√çDIA (IMAGENS E ARQUIVOS) */
  .bubble img {
      max-width: 100%;
      border-radius: 5px;
      margin-top: 5px;
      cursor: pointer;
  }
  .file-attachment {
      display: flex;
      align-items: center;
      gap: 10px;
      background: rgba(0,0,0,0.05);
      padding: 10px;
      border-radius: 5px;
      text-decoration: none;
      color: #333;
      font-weight: 500;
  }
  .file-icon { font-size: 24px; }

  /* BARRA DE DIGITAR */
  .composer { padding:10px; background:var(--input-bg); display:flex; gap:10px; align-items: center; border-top: 1px solid #ddd; flex-shrink: 0; }
  input[type="text"] { flex:1; padding:12px; border-radius:20px; border:none; outline:none; background: white; font-size: 15px; transition: all 0.2s; color: var(--text-color); }
  input:disabled { background: #e0e0e0; cursor: not-allowed; }

  /* BOTOES REDONDOS */
  .btn-send, .btn-mic, .btn-attach { 
    background:var(--top); 
    color:white; 
    border:none; 
    width: 45px; 
    height: 45px; 
    border-radius:50%; 
    cursor:pointer; 
    font-size: 18px; 
    display: flex; 
    align-items: center; 
    justify-content: center; 
    transition: background 0.2s;
    flex-shrink: 0;
  }
  .btn-mic { background: var(--mic-btn); }
  .btn-attach { background: transparent; color: #666; font-size: 24px; transform: rotate(45deg); width: 40px; }
  .btn-attach:hover { background: rgba(0,0,0,0.1); }

  /* MODO DE GRAVA√á√ÉO */
  .recording-status { 
      flex: 1; 
      display: none; 
      align-items: center; 
      gap: 10px; 
      color: var(--top);
      font-weight: bold;
      padding-left: 10px;
  }
  .recording-status.active { display: flex; }
  .recording-status .dot { 
      width: 10px; 
      height: 10px; 
      background: red; 
      border-radius: 50%; 
      animation: pulse 1s infinite; 
  }
  @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
  }
  
  /* ESTILO DO √ÅUDIO */
  .audio-player-wrap { 
    display: flex; 
    align-items: center; 
    gap: 8px; 
    min-width: 150px; 
    padding: 2px 0;
  }
  .audio-player-wrap audio { display: none; }
  .btn-audio-control {
    background: var(--top);
    color: white;
    width: 35px;
    height: 35px;
    border-radius: 50%;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    flex-shrink: 0;
  }
  .audio-time { 
    font-size: 12px; 
    color: var(--text-secondary, #555);
    flex-grow: 1;
    margin-right: 5px;
  }

  /* MODAL DE ENTRADA NA SALA */
  .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 100; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
  .modal-box { background: white; padding: 25px; border-radius: 15px; width: 90%; max-width: 350px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.3); }
  .modal-box h2 { color: var(--top); margin-top: 0; }
  .modal-box input { width: 100%; padding: 12px; margin: 15px 0; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box; text-align: center; }
  .modal-box input:focus { border-color: var(--top); }
  .btn-enter { background: var(--top); color: white; padding: 12px; width: 100%; border: none; border-radius: 8px; font-weight: bold; font-size: 16px; cursor: pointer; }
  .hidden { display: none !important; }
</style>
</head>
<body>

<div class="card">
    <div class="topbar">
        <div style="display:flex; align-items:center;">
            <a href="/" class="btn-back">‚¨Ö</a> 
            <div>
                <div style="font-weight:bold; font-size: 16px;" id="roomName">Privado</div>
                <div style="font-size:12px; opacity: 0.8;">Chat Secreto</div>
            </div>
        </div>
    </div>

    <div id="messagesWrap" class="messages-wrap"></div>

    <div class="composer">
        <!-- Input de Arquivo Oculto -->
        <input type="file" id="fileInput" style="display: none;" onchange="handleFileSelect()">
        
        <!-- Bot√£o de Clips -->
        <button class="btn-attach" onclick="document.getElementById('fileInput').click()">üìé</button>

        <input type="text" id="txt" placeholder="Digite aqui..." autofocus>
        
        <div id="recordingStatus" class="recording-status">
            <div class="dot"></div>
            <span id="recTimer">0:00</span>
        </div>
        <button id="sendBtn" class="btn-send" onclick="send()">‚û§</button>
        <button 
            id="micBtn" 
            class="btn-mic" 
            onmousedown="handleMicPress(event)" 
            onmouseup="handleMicRelease()" 
            ontouchstart="handleMicPress(event)" 
            ontouchend="handleMicRelease()">üé§</button>
    </div>
</div>

<div id="loginRoomModal" class="modal-overlay">
    <div class="modal-box">
        <h2>üîí Chat Privado</h2>
        <p>Crie um nome para a sala ou digite um existente para entrar.</p>
        <input type="text" id="inputSala" placeholder="Ex: familia123">
        <button class="btn-enter" onclick="entrarSala()">ENTRAR NA SALA</button>
        <br><br>
        <a href="/" style="color: #666; text-decoration: none; font-size: 14px;">Voltar ao In√≠cio</a>
    </div>
</div>

<script>
    // --- CHAVES SUPABASE (MANTIDAS) ---
    const SUPABASE_URL = 'https://zlppiyhqlhppbhkurisr.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpscHBpeWhxbGhwcGJoa3VyaXNyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4NjA0MzYsImV4cCI6MjA3OTQzNjQzNn0.ybVSaBl18pz8OQbtL65Fqn3dIQ4H8qd4OuGRp6ngFnI';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    
    // Elementos DOM
    const el = {
        messagesWrap: document.getElementById('messagesWrap'),
        txt: document.getElementById('txt'),
        sendBtn: document.getElementById('sendBtn'),
        micBtn: document.getElementById('micBtn'),
        recordingStatus: document.getElementById('recordingStatus'),
        recTimer: document.getElementById('recTimer'),
        fileInput: document.getElementById('fileInput')
    };

    let currentUser = null;
    let currentRoom = null;
    let localMessageIdCounter = 0; 
    let mediaRecorder = null;
    let audioChunks = [];
    let isRecording = false;
    let recordingTimerId = null;
    let recordingStartTime = 0;
    let currentStream = null;
    let currentlyPlayingAudio = null;
    let fileToSend = null; 
    let pressTimer; 

    // --- FUN√á√ïES DE UTILIADADE ---

    function scrollToBottom() { 
        setTimeout(() => { el.messagesWrap.scrollTop = el.messagesWrap.scrollHeight; }, 50);
    }
    
    function formatTime(seconds) {
        const min = Math.floor(seconds / 60);
        const sec = Math.floor(seconds % 60);
        return `${min}:${sec < 10 ? '0' : ''}${sec}`;
    }
    
    function setInterfaceEnabled(enabled) {
        el.txt.disabled = !enabled;
        el.sendBtn.disabled = !enabled;
        el.micBtn.disabled = !enabled;
    }

    // --- AUTENTICA√á√ÉO E ENTRADA NA SALA ---

    async function init() {
        try {
            const {data} = await supabaseClient.auth.getSession();
            
            if(!data.session) {
                return window.location.href = '/'; 
            }
            
            currentUser = data.session.user;
            
            updateComposerButtons();
            
            el.txt.onkeydown = (e) => { if(e.key === 'Enter') send(); };
            el.txt.oninput = updateComposerButtons;

        } catch (e) {
            console.error("Erro na inicializa√ß√£o da sess√£o:", e);
            window.location.href = '/';
        }
    }
    init();

    function updateComposerButtons() {
        const hasText = el.txt.value.trim() !== '';
        
        if (isRecording) {
            el.sendBtn.style.display = 'none';
            el.micBtn.style.display = 'none';
            el.txt.classList.add('hidden');
            el.recordingStatus.classList.add('active');
        } else {
            el.sendBtn.style.display = hasText ? 'flex' : 'none';
            el.micBtn.style.display = hasText ? 'none' : 'flex'; 
            el.txt.classList.remove('hidden');
            el.recordingStatus.classList.remove('active');
        }
    }

    function entrarSala() {
        const salaInput = document.getElementById('inputSala').value.trim();
        if(!salaInput) return alert("Digite um nome para a sala!");

        currentRoom = salaInput.toLowerCase().replace(/\s/g, ''); 
        
        document.getElementById('roomName').textContent = "Sala: " + currentRoom;
        document.getElementById('loginRoomModal').classList.add('hidden'); 
        
        fetchMessages();
        setupRealtime();
    }

    // --- SELE√á√ÉO DE ARQUIVO ---
    function handleFileSelect() {
        const file = el.fileInput.files[0];
        if (file) {
            fileToSend = file;
            send(); // Envia automaticamente ao selecionar
            el.fileInput.value = ''; // Limpa o input
        }
    }

    // --- GRAVA√á√ÉO DE √ÅUDIO ---
    
    async function startRecording() {
        if (isRecording) return;
        
        try {
            currentStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(currentStream);
            audioChunks = [];

            mediaRecorder.ondataavailable = e => {
                if (e.data.size > 0) audioChunks.push(e.data);
            };

            mediaRecorder.onstop = () => {
                clearInterval(recordingTimerId);
                isRecording = false;
                
                uploadAudio();
                
                if (currentStream) {
                    currentStream.getTracks().forEach(track => track.stop());
                }
                updateComposerButtons();
            };

            mediaRecorder.start();
            isRecording = true;
            
            recordingStartTime = Date.now();
            el.recTimer.textContent = '0:00';
            recordingTimerId = setInterval(() => {
                const elapsedSeconds = Math.floor((Date.now() - recordingStartTime) / 1000);
                el.recTimer.textContent = formatTime(elapsedSeconds);
            }, 1000);
            
            updateComposerButtons();

        } catch (e) {
            alert("Erro ao acessar o microfone: Verifique as permiss√µes. " + e.message);
            isRecording = false;
            updateComposerButtons();
        }
    }

    function stopRecording() {
        if (!isRecording) return;
        
        if (mediaRecorder && mediaRecorder.state === 'recording') {
            mediaRecorder.stop();
        }
    }
    
    function handleMicPress(event) {
        event.preventDefault(); 
        pressTimer = setTimeout(startRecording, 300);
    }

    function handleMicRelease() {
        clearTimeout(pressTimer);
        if (isRecording) {
            stopRecording();
        }
    }
    
    async function uploadAudio() {
        if (audioChunks.length === 0) return; 

        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
        
        if (audioBlob.size < 3000) { // Pequeno filtro de ru√≠do
            alert("√Åudio muito curto."); 
            return; 
        }
        
        fileToSend = audioBlob;
        send();
    }

    // --- √ÅUDIO PLAYBACK ---

    window.playAudio = (btn, url) => {
        const audio = btn.nextElementSibling;
        const timeEl = audio.nextElementSibling;
        
        if (currentlyPlayingAudio && currentlyPlayingAudio !== audio) {
            currentlyPlayingAudio.pause();
            currentlyPlayingAudio.currentTime = 0;
            const playingBtn = currentlyPlayingAudio.previousElementSibling;
            if (playingBtn) playingBtn.innerHTML = '‚ñ∂';
            const playingTimeEl = currentlyPlayingAudio.nextElementSibling;
            if (playingTimeEl) playingTimeEl.textContent = playingTimeEl.dataset.duration || '0:00';
        }
        
        if (audio.paused) {
            currentlyPlayingAudio = audio;
            audio.play();
            btn.innerHTML = '‚ùö‚ùö';
        } else {
            audio.pause();
            currentlyPlayingAudio = null;
            btn.innerHTML = '‚ñ∂';
        }

        audio.ontimeupdate = () => {
             timeEl.textContent = formatTime(audio.currentTime);
        };
        
        audio.onended = () => {
            audio.currentTime = 0;
            currentlyPlayingAudio = null;
            btn.innerHTML = '‚ñ∂';
            timeEl.textContent = timeEl.dataset.duration || '0:00'; 
        };
    }
    
    // --- CARREGAMENTO E RENDERIZA√á√ÉO ---

    async function fetchMessages() {
        const { data } = await supabaseClient.from('banco')
            .select('*')
            .eq('sala_id', currentRoom)
            .order('created_at', { ascending: true });
            
        el.messagesWrap.innerHTML = '';
        if(data) data.forEach(msg => renderMessage(msg, false)); 
        scrollToBottom();
    }

    function renderMessage(msg, isRealtime = false) {
        
        const isMe = msg.user_id === currentUser.id;
        let existingElement = document.getElementById(msg.id);

        if (isRealtime && isMe && existingElement) {
            existingElement.classList.remove('pending');
            existingElement.querySelector('.status-icon').innerHTML = '‚úî';
            // Atualiza link final se necess√°rio
            if((msg.tipo === 'imagem' || msg.tipo === 'arquivo') && msg.texto.startsWith('http')) {
                const contentDiv = existingElement.querySelector('.msg-content');
                if(contentDiv) contentDiv.innerHTML = createContentHTML(msg);
            }
            return; 
        }
        
        if (isRealtime && isMe && !existingElement) {
            return; 
        }
        
        const div = existingElement || document.createElement('div');
        const isNewMessage = !existingElement;
        
        if (isNewMessage) {
            div.className = `bubble ${isMe ? 'me' : ''} ${msg.local ? 'pending' : ''}`;
            div.id = msg.id; 
        }
        
        const timestamp = new Date(msg.created_at || Date.now()).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        
        const contentHTML = createContentHTML(msg);
        
        let statusIcon = '';
        if (isMe) {
            statusIcon = msg.local ? '<span class="status-icon">üïí</span>' : '<span class="status-icon" style="color:var(--status-sent, #008000);">‚úî</span>'; 
        }
        
        div.innerHTML = `
            <div class="bubble-autor">${msg.autor_nome}</div>
            <div class="msg-content">${contentHTML}</div>
            <div class="meta">${timestamp}${statusIcon}</div>
        `;
        
        if (isNewMessage) {
            el.messagesWrap.appendChild(div);
        }

        scrollToBottom();
        
        if (msg.tipo === 'audio' && !msg.local) {
             const audioEl = div.querySelector('audio');
             const timeEl = div.querySelector('.audio-time');
             if(audioEl) {
                 audioEl.onloadedmetadata = () => {
                     const duration = formatTime(audioEl.duration);
                     timeEl.textContent = duration;
                     timeEl.dataset.duration = duration;
                 };
             }
        }
    }

    function createContentHTML(msg) {
        if (msg.tipo === 'audio') {
            const url = msg.texto; 
            const initialTime = msg.local ? 'Gravando...' : '√Åudio';
            return `
                <div class="audio-player-wrap">
                    <button class="btn-audio-control" onclick="playAudio(this, '${url}')">‚ñ∂</button>
                    <audio src="${url}"></audio>
                    <span class="audio-time" data-duration="${initialTime}">${initialTime}</span>
                </div>
            `;
        } else if (msg.tipo === 'imagem') {
            return `<a href="${msg.texto}" target="_blank"><img src="${msg.texto}" alt="Imagem"></a>`;
        } else if (msg.tipo === 'arquivo') {
            // Tenta extrair o nome do arquivo da URL ou usa gen√©rico
            let fileName = 'Arquivo Anexo';
            try { fileName = decodeURIComponent(msg.texto.split('/').pop().split('?')[0]).split('_').slice(1).join('_'); } catch(e){}
            if(msg.local) fileName = "Enviando arquivo...";

            return `
                <a href="${msg.texto}" target="_blank" class="file-attachment">
                    <span class="file-icon">üìÑ</span>
                    <span>${fileName.substring(0,25)}...</span>
                </a>
            `;
        } else {
            return msg.texto.replace(/\n/g, '<br>');
        }
    }

    // --- ENVIO (Texto, √Åudio e Arquivos) ---

    async function send() {
        const texto = el.txt.value.trim();
        const hasFile = !!fileToSend;
        
        if(!texto && !hasFile || !currentUser || !currentRoom) return; 
        
        el.txt.value = ''; 
        setInterfaceEnabled(false); 

        const localId = 'local-' + localMessageIdCounter++;
        let url = null;
        let dbText = texto;
        let msgType = 'text';
        let uploadFolder = 'private_files';

        // 1. Defini√ß√£o do Tipo
        if (hasFile) {
            if (fileToSend.type.includes('audio')) {
                msgType = 'audio';
                uploadFolder = 'private_audio';
                dbText = URL.createObjectURL(fileToSend); 
            } else if (fileToSend.type.includes('image')) {
                msgType = 'imagem';
                dbText = URL.createObjectURL(fileToSend); 
            } else {
                msgType = 'arquivo';
                dbText = '#'; // Placeholder local
            }
        }
        
        // Renderiza bolha local (Optimistic)
        const optimisticMsg = {
            id: localId,
            texto: dbText,
            user_id: currentUser.id,
            autor_nome: currentUser.user_metadata.full_name,
            created_at: new Date().toISOString(),
            tipo: msgType,
            local: true
        };
        renderMessage(optimisticMsg);
        
        try {
            // 2. Upload do Arquivo (Se houver)
            if (hasFile) {
                const ext = fileToSend.name ? fileToSend.name.split('.').pop() : 'webm';
                const fileNameClean = fileToSend.name ? fileToSend.name.replace(/[^a-zA-Z0-9.]/g, '_') : 'audio';
                const uploadName = `${uploadFolder}/${currentRoom}/${currentUser.id}_${Date.now()}_${fileNameClean}`;
                
                const { error: uploadError } = await supabaseClient.storage.from('arquivos').upload(uploadName, fileToSend, {
                    contentType: fileToSend.type,
                    cacheControl: '3600'
                });
                if (uploadError) throw uploadError;

                const { data: { publicUrl } } = supabaseClient.storage.from('arquivos').getPublicUrl(uploadName);
                url = publicUrl;
                
                if(dbText.startsWith('blob:')) URL.revokeObjectURL(dbText);
            }

            // 3. Inserir mensagem no banco
            const { error: insertError } = await supabaseClient.from('banco').insert([{
                texto: hasFile ? url : texto, 
                user_id: currentUser.id,
                autor_nome: currentUser.user_metadata.full_name,
                sala_id: currentRoom,
                tipo: msgType 
            }]);
            if (insertError) throw insertError;

        } catch (e) {
            console.error("Falha ao enviar mensagem:", e);
            alert("Erro ao enviar. " + e.message);
            
            const localDiv = document.getElementById(localId);
            if (localDiv) {
                localDiv.querySelector('.status-icon').innerHTML = '‚ùå';
            }
        } finally {
            fileToSend = null; 
            setInterfaceEnabled(true);
            updateComposerButtons();
        }
    }

    // --- TEMPO REAL ---
    function setupRealtime() {
        supabaseClient.channel(`private-room:${currentRoom}`)
        .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'banco', filter: `sala_id=eq.${currentRoom}` }, payload => {
            
            const isMe = payload.new.user_id === currentUser.id;
            
            if (isMe) {
                const pendingBubble = el.messagesWrap.querySelector('.bubble.me.pending');
                if (pendingBubble) {
                    // Otimiza√ß√£o: remove o pendente para substituir pelo oficial
                    pendingBubble.remove();
                }
            }

            renderMessage(payload.new, true);

        }).subscribe();
    }
</script>
</body>
  </html>
