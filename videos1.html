<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>Chat Brasil Video</title>

<!-- Supabase CDN -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<!-- PeerJS CDN para Videoconfer√™ncia -->
<script src="https://cdn.jsdelivr.net/npm/peerjs@1.5.2/dist/peerjs.min.js"></script>

<style>
/* -----------------------------------------------------------
   ESTILO GERAL (100% inspirado no WhatsApp Mobile Android)
-----------------------------------------------------------*/
:root{
  --bg:#e5ddd5;
  --panel:#fff;
  --chat-bg:#f0f0f0;
  --my:#dcf8c6;
  --accent:#25d366;
  --header:#075e54;
  --dark:#111;
}

/* CORRE√á√ÉO DE LAYOUT PARA MOBILE (Resolvendo o problema do 100vh) */
html, body {
  height: 100%; 
  margin: 0;
}

body{
  background:var(--bg);
  font-family:Arial, sans-serif;
  display:flex;
  flex-direction:column;
  overflow: hidden; 
}
/* FIM DA CORRE√á√ÉO DE LAYOUT */


/* HEADER */
#topbar{
  height:56px;
  background:var(--header);
  display:flex;
  align-items:center;
  padding:0 12px;
  color:#fff;
  font-size:18px;
  font-weight:bold;
  justify-content: space-between;
  position: relative;
  flex-shrink: 0;
}
#topbar-left {
    display: flex;
    align-items: center;
}
#kebabBtn {
    background: none;
    border: none;
    color: white;
    font-size: 24px;
    margin-left: 10px;
    cursor: pointer;
    line-height: 1;
    padding: 0 5px;
}

/* MENU SUSPENSO */
#kebabMenu {
    position: absolute;
    top: 50px; 
    right: 5px;
    background: white;
    border-radius: 4px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    min-width: 250px; 
    z-index: 1000;
    display: none;
}
.menu-item {
    padding: 12px 16px;
    font-size: 15px;
    color: var(--dark);
    text-decoration: none;
    display: block;
    font-weight: normal;
    cursor: pointer;
}
.menu-item:hover {
    background: #f1f1f1;
}
.danger-item {
    color: #e74c3c; 
    font-weight: bold;
}

/* CONTAINER PRINCIPAL DO CHAT */
#messages-container{
    flex:1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    position: relative;
    background-color: var(--bg);
}

/* √ÅREA DA VIDEOCHAMADA */
#videoCallArea {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: var(--dark);
    display: none; /* Inicia oculto */
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 900;
}

#remoteVideo, #localVideo {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 0;
}

#localVideo {
    position: absolute;
    top: 10px;
    right: 10px;
    width: 30%;
    max-width: 120px;
    height: auto;
    border-radius: 8px;
    z-index: 910;
    box-shadow: 0 0 5px rgba(0,0,0,0.5);
    border: 2px solid white;
}

#hangUpBtn {
    position: absolute;
    bottom: 20px;
    width: 60px;
    height: 60px;
    background: red;
    border: none;
    border-radius: 50%;
    color: white;
    font-size: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 920;
    box-shadow: 0 4px 8px rgba(0,0,0,0.3);
}


/* LISTA DE MENSAGENS */
#messages{
  flex:1; 
  overflow-y:auto; 
  padding:10px;
  display:flex;
  flex-direction:column;
  scroll-behavior: smooth;
  background-color: transparent; /* Permite que o bg seja o do #messages-container ou personalizado */
}
.msg{
  max-width:80%; 
  padding:8px 12px;
  margin-bottom:6px;
  border-radius:8px;
  font-size:15px;
  line-height:1.3;
}
/* Adapta a largura para conte√∫do de m√≠dia que √© maior */
.msg[data-media="true"] {
    max-width: 280px; 
}
.me{
  align-self:flex-end;
  background:var(--my);
}
.other{
  align-self:flex-start;
  background:#fff;
}
/* Estilo para arquivos, imagens e v√≠deos */
.msg .file-content {
    display: flex;
    flex-direction: column;
    gap: 5px;
}
.msg img {
    max-width: 200px;
    height: auto;
    border-radius: 6px;
}
.msg video {
    max-width: 100%;
    height: auto;
    border-radius: 6px;
}
.msg a {
    color: var(--header);
    text-decoration: none;
    font-weight: bold;
}
.msg .file-icon {
    margin-right: 5px;
}


/* INPUT AREA */
#inputArea{
  height:60px; 
  background:#fff;
  display:flex;
  align-items:center;
  padding:0 6px;
  gap:6px;
  flex-shrink: 0; 
}
#textInput{
  flex:1;
  height:40px;
  border:1px solid #ccc;
  border-radius:20px;
  padding:0 14px;
  font-size:15px;
}
.btn{
  width:42px;
  height:42px;
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
  background:var(--accent);
  border:none;
  color:#fff;
  cursor: pointer;
}
/* Estilo para o bot√£o de videocall - usa cor mais distintiva */
#videoCallBtn {
    background: #008000; /* Verde escuro */
    font-size: 20px;
}
/* Estilo para o bot√£o de microfone quando gravando */
#audioBtn.recording {
    background: red;
    animation: pulse 1s infinite;
}
@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
}


/* LOGIN MODAL */
#loginModal{
  position:fixed;
  top:0; left:0;
  width:100%; height:100%;
  background:#fff;
  z-index:9999;
  padding:20px;
  display:flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}
#loginModal div {
    width: 100%;
    max-width: 300px;
}
#loginModal input{
  width:100%;
  padding:12px;
  margin:6px 0;
  border-radius:6px;
  border:1px solid #ccc;
  box-sizing: border-box;
}
#loginModal button {
    width: 100%;
    max-width: 300px;
    padding: 10px;
    margin-top: 10px;
    border: none;
    border-radius: 6px;
    background: var(--accent);
    color: white;
    font-size: 16px;
    cursor: pointer;
}
#loginModal button:hover {
    opacity: 0.9;
}
</style>
</head>
<body>

<div id="topbar">
    <div id="topbar-left">
        <span id="chatTitle">Chat Brasil Video</span>
    </div>
    <button id="kebabBtn">‚ãÆ</button>
    
    <div id="kebabMenu">
        <!-- LINK PARA VOLTAR AO CHAT PRINCIPAL -->
        <a href="index.html" class="menu-item">Ir para Chat Principal üí¨</a>
        
        <input type="file" id="bgFile" accept="image/*" style="display: none;" onchange="setBackground(this.files[0])">
        <a class="menu-item" onclick="document.getElementById('bgFile').click()">üñºÔ∏è Trocar Fundo de Tela</a>
        
        <!-- NOVO ITEM: APAGAR MENSAGENS -->
        <a class="menu-item danger-item" onclick="confirmClearChat()">
            üóëÔ∏è Apagar Todas as Mensagens
        </a>
        
        <a href="perfil1.html" target="_blank" class="menu-item">P√°gina de Perfil</a>
        <a href="termos1.html" target="_blank" class="menu-item">Termos e Condi√ß√µes</a>
        <a class="menu-item" onclick="logout()">Sair</a>
    </div>
</div>

<div id="messages-container">
    <!-- √Årea que aparece sobre o chat quando a videochamada est√° ativa -->
    <div id="videoCallArea">
        <video id="remoteVideo" autoplay playsinline></video>
        <!-- O 'muted' √© essencial para que o navegador n√£o bloqueie o autoplay da c√¢mera local -->
        <video id="localVideo" autoplay playsinline muted></video>
        <button id="hangUpBtn" onclick="hangUpCall()">üìû</button>
        <!-- Esta √© a √∫nica linha que mostra status, NUNCA 'Simula√ß√£o de Videochamada' -->
        <p style="position: absolute; top: 10px; color: white; font-weight: bold;" id="callStatus"></p>
    </div>
    <div id="messages"></div>
</div>

<div id="inputArea">
  <!-- Bot√µes adaptados para m√≠dia no chat de v√≠deo -->
  <button id="fileBtn" class="btn">üìé</button>
  <input type="file" id="fileInput" accept="image/*,video/*,application/*" style="display: none;" onchange="uploadFile(this.files[0])">
  <button id="videoCallBtn" class="btn" title="Iniciar Videochamada">üé•</button>
  <button id="audioBtn" class="btn">üé§</button>
  <input id="textInput" placeholder="Mensagem">
  <button id="sendBtn" class="btn">‚û§</button>
</div>

<div id="loginModal">
  <div>
    <h2>Entrar</h2>
    <input id="email" placeholder="Email">
    <input id="pass" placeholder="Senha" type="password">
    <button onclick="login()">Entrar</button>
    <button onclick="register()">Registrar</button>
    <button onclick="reset()">Esqueci a senha</button>
  </div>
</div>

<script>
/* -----------------------------------------------------------
   CONFIGURA√á√ÉO SUPABASE
-----------------------------------------------------------*/
// Chaves do Supabase (reutilizadas)
const SUPABASE_URL = "https://qytxdewvwpfdulsiweyi.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF5dHhkZXd2d3BmZHVsc2l3ZXlpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ0NjI5NzYsImV4cCI6MjA4MDAzODk3Nn0.fPquiaUntC89YT6tqvB0lqg8oRdwSN0kN-CnhCPOu_Q";

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let user = null;

// Elementos DOM
const messagesDiv = document.getElementById("messages");
const loginModal = document.getElementById("loginModal");
const emailInput = document.getElementById("email");
const passInput = document.getElementById("pass");
const textInput = document.getElementById("textInput");
const sendBtn = document.getElementById("sendBtn");
const chatTitle = document.getElementById("chatTitle");
const kebabBtn = document.getElementById("kebabBtn");
const kebabMenu = document.getElementById("kebabMenu");
const audioBtn = document.getElementById("audioBtn");
const fileBtn = document.getElementById("fileBtn");
const fileInput = document.getElementById("fileInput");
const videoCallBtn = document.getElementById("videoCallBtn");
const videoCallArea = document.getElementById("videoCallArea");
const localVideo = document.getElementById("localVideo");
const remoteVideo = document.getElementById("remoteVideo");
const callStatus = document.getElementById("callStatus");

// Evento para abrir o seletor de arquivos
fileBtn.onclick = () => {
    if (!user) {
        alert("Voc√™ deve estar logado para enviar arquivos."); 
        return;
    }
    fileInput.click();
};


/* -----------------------------------------------------------
   AUTENTICA√á√ÉO
-----------------------------------------------------------*/
async function login(){
    const emailValue = emailInput.value.trim();
    const passValue = passInput.value;
    if (!emailValue || !passValue) { alert("Preencha email e senha."); return; }

    const {data, error} = await sb.auth.signInWithPassword({ email: emailValue, password: passValue });
    if(error){ alert("Erro ao fazer login: " + error.message); return; }

    user = data.user;
    initializeChat();
}

async function register(){
    const emailValue = emailInput.value.trim();
    if (!emailValue.includes('@') || !emailValue.includes('.')) {
        alert("Erro ao registrar: O formato do email parece inv√°lido.");
        return;
    }
    const {error} = await sb.auth.signUp({ email: emailValue, password: passValue });
    if(error) alert("Registrado! Confirme o email e tente fazer login.");
    else alert("Registrado! Confirme o email e tente fazer login.");
}

async function reset(){
    const emailValue = emailInput.value.trim();
    if (!emailValue || !emailValue.includes('@')) { alert("Preencha um email v√°lido."); return; }
    const {error} = await sb.auth.resetPasswordForEmail(emailValue);
    if(error) alert("Email de recupera√ß√£o enviado!");
    else alert("Email de recupera√ß√£o enviado!");
}

async function logout(){
    if (window.peer) window.peer.destroy();
    if (window.localStream) window.localStream.getTracks().forEach(track => track.stop());

    const { error } = await sb.auth.signOut();
    if (error) {
        alert("Erro ao sair: " + error.message);
    } else {
        user = null;
        messagesDiv.innerHTML = "";
        loginModal.style.display = "flex";
        chatTitle.textContent = "Chat Brasil Video";
        window.location.reload(); 
    }
}


/* -----------------------------------------------------------
   CHAT ‚Äî ENVIAR / RENDERIZAR / RECEBER
-----------------------------------------------------------*/
sendBtn.onclick = sendMessage;
textInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') { sendMessage(); } });

async function sendMessage(){
  const text = textInput.value.trim();
  if(!text || !user) return;

  const { error } = await sb.from("messages").insert({
    user_id: user.id,
    text: text
  });

  if (error) {
      alert("Erro ao enviar mensagem: " + error.message);
  } else {
      textInput.value = "";
  }
}

function renderMessage(msg){
  const div = document.createElement("div");
  div.className = "msg " + (msg.user_id === user.id ? "me" : "other");
  div.removeAttribute('data-media'); 

  let contentHTML = msg.text;
  const mediaPrefixes = {
    '[√Åudio]:': 'audio',
    '[Imagem]:': 'image',
    '[V√≠deo]:': 'video', 
    '[Arquivo]:': 'file' 
  };

  for (const prefix in mediaPrefixes) {
    if (msg.text.startsWith(prefix)) {
        const type = mediaPrefixes[prefix];
        const storagePath = msg.text.substring(prefix.length).trim();
        const { data: publicUrlData } = sb.storage.from('chat-media').getPublicUrl(storagePath);
        const fileUrl = publicUrlData.publicUrl;
        const fileExt = storagePath.split('.').pop().toLowerCase();
        
        div.setAttribute('data-media', 'true'); 

        if (type === 'audio') {
            const mimeType = fileExt === 'mp3' ? 'audio/mpeg' : 'audio/webm';
            contentHTML = `
                <div class="file-content">
                    üé§ **√Åudio**
                    <audio controls style="width: 100%; max-width: 250px;">
                        <source src="${fileUrl}" type="${mimeType}">
                        Seu navegador n√£o suporta a reprodu√ß√£o.
                    </audio>
                </div>
            `;
        } else if (type === 'image') {
             contentHTML = `
                <div class="file-content">
                    üñºÔ∏è **Imagem**
                    <a href="${fileUrl}" target="_blank">
                        <img src="${fileUrl}" alt="Imagem do Chat" />
                    </a>
                </div>
            `;
        } else if (type === 'video') {
             const mimeType = fileExt === 'mp4' ? 'video/mp4' : (fileExt === 'webm' ? 'video/webm' : 'video/ogg');
             contentHTML = `
                <div class="file-content">
                    üìπ **V√≠deo**
                    <video controls style="width: 100%; max-width: 250px;">
                        <source src="${fileUrl}" type="${mimeType}">
                        Seu navegador n√£o suporta v√≠deos.
                    </video>
                </div>
            `;
        } else if (type === 'file') {
             const fileName = storagePath.substring(storagePath.lastIndexOf('/') + 1);
             contentHTML = `
                <div class="file-content">
                    üì¶ **Arquivo**
                    <a href="${fileUrl}" target="_blank" download>
                        <span class="file-icon">‚Üì</span> ${fileName}
                    </a>
                </div>
            `;
        }
        break; 
    }
  }

  div.innerHTML = contentHTML;
  messagesDiv.appendChild(div);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
}


function subscribeToMessages() {
    if (window.chatChannel) sb.removeChannel(window.chatChannel);

    window.chatChannel = sb.channel("msgs")
      .on("postgres_changes", { event: "INSERT", schema: "public", table: "messages" },
        payload => {
            if (user) {
                renderMessage(payload.new);
            }
        }
      )
      .subscribe();
}

async function loadHistory(){
  let {data, error} = await sb.from("messages")
    .select("*").order("created_at",{ascending:true});

  if (error) {
      alert("Erro ao carregar hist√≥rico: " + error.message);
      return;
  }
  
  messagesDiv.innerHTML = "";
  data.forEach(renderMessage);
}


/* -----------------------------------------------------------
   FUN√á√ÉO: APAGAR TODAS AS MENSAGENS (DO USU√ÅRIO LOGADO)
-----------------------------------------------------------*/
async function confirmClearChat() {
    kebabMenu.style.display = 'none'; 
    
    if (!user) {
        alert("Voc√™ deve estar logado para apagar mensagens.");
        return;
    }

    const confirmation = prompt("ATEN√á√ÉO: Voc√™ est√° prestes a apagar TODAS as suas mensagens (apenas as suas). Digite 'CONFIRMAR' para continuar:");

    if (confirmation !== 'CONFIRMAR') {
        alert("A√ß√£o cancelada.");
        return;
    }

    // Apagar todas as linhas da tabela 'messages'
    const { error: deleteError } = await sb.from('messages')
        .delete()
        .eq('user_id', user.id); 

    if (deleteError) {
        console.error("Erro ao apagar mensagens:", deleteError.message);
        alert("ERRO: Falha ao apagar mensagens. Verifique as pol√≠ticas de RLS para DELETE na tabela 'messages'.");
    } else {
        alert("Todas as suas mensagens foram apagadas com sucesso!");
        messagesDiv.innerHTML = "";
        loadHistory();
    }
}


/* -----------------------------------------------------------
   MENU E FUNDO DE TELA
-----------------------------------------------------------*/
kebabBtn.onclick = () => {
    kebabMenu.style.display = kebabMenu.style.display === 'block' ? 'none' : 'block';
};

document.addEventListener('click', (e) => {
    if (e.target !== kebabBtn && !kebabMenu.contains(e.target)) {
        kebabMenu.style.display = 'none';
    }
});

function setBackground(file) {
    if (file) {
        const url = URL.createObjectURL(file);
        // Aplica ao container principal do chat
        document.getElementById('messages-container').style.backgroundImage = `url('${url}')`;
        document.getElementById('messages-container').style.backgroundSize = 'cover';
        document.getElementById('messages-container').style.backgroundPosition = 'center';
    }
}


/* -----------------------------------------------------------
   UPLOAD DE ARQUIVOS (M√çDIA GERAL)
-----------------------------------------------------------*/
async function uploadFile(file) {
    if (!file || !user) return;

    const mimeType = file.type;
    
    let messagePrefix;
    if (mimeType.startsWith('video/')) {
        messagePrefix = '[V√≠deo]: '; 
    } else if (mimeType.startsWith('image/')) {
        messagePrefix = '[Imagem]: ';
    } else {
        messagePrefix = '[Arquivo]: ';
    }
    
    const fileName = file.name.replace(/[^a-z0-9.]/gi, '_').toLowerCase(); 
    const filePath = `${user.id}/${Date.now()}_${fileName}`; 

    const { data: uploadData, error: uploadError } = await sb.storage
        .from('chat-media') 
        .upload(filePath, file, {
            cacheControl: '3600',
            upsert: false,
            contentType: mimeType
        });

    if (uploadError) {
        console.error("Erro no upload de arquivo:", uploadError);
        alert("ERRO: Falha ao enviar o arquivo. " + uploadError.message);
    } else {
        const storagePath = uploadData.path;

        const { error: dbError } = await sb.from("messages").insert({
            user_id: user.id,
            text: `${messagePrefix}${storagePath}` 
        });

        if (dbError) {
            alert("ERRO: Falha ao registrar mensagem no DB: " + dbError.message);
        } else {
            console.log(`Upload de arquivo bem-sucedido: ${storagePath}`);
        }
    }
    
    fileInput.value = '';
}


/* -----------------------------------------------------------
   GRAVA√á√ÉO DE √ÅUDIO (MICROFONE)
-----------------------------------------------------------*/
let mediaRecorder;
let audioChunks = [];
let isRecording = false;
let audioStream;

audioBtn.onclick = async () => {
    if (!user) {
        alert("Voc√™ deve estar logado para usar o microfone.");
        return;
    }

    if (isRecording) {
        if (mediaRecorder) {
            mediaRecorder.stop();
        }
        audioBtn.classList.remove('recording');
        isRecording = false;
    } else {
        try {
            audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            const mimeType = 'audio/webm'; 
            mediaRecorder = new MediaRecorder(audioStream, { mimeType: mimeType });
            audioChunks = [];
            
            mediaRecorder.ondataavailable = e => {
                if (e.data.size > 0) {
                    audioChunks.push(e.data);
                }
            };

            mediaRecorder.onstop = async () => {
                let blob = new Blob(audioChunks, { type: mimeType });
                
                if (blob.size < 100) { 
                    alert("Grava√ß√£o muito curta ou vazia.");
                    if (audioStream) audioStream.getTracks().forEach(track => track.stop());
                    return;
                }
                
                const fileExtension = 'webm';
                const filePath = `${user.id}/${Date.now()}.${fileExtension}`; 

                const { data: uploadData, error: uploadError } = await sb.storage
                    .from('chat-media') 
                    .upload(filePath, blob, {
                        cacheControl: '3600',
                        upsert: false,
                        contentType: mimeType
                    });

                if (uploadError) {
                    console.error("Erro no upload para Storage:", uploadError);
                    alert("ERRO: Falha ao enviar √°udio. " + uploadError.message);
                } else {
                    const storagePath = uploadData.path;

                    const { error: dbError } = await sb.from("messages").insert({
                        user_id: user.id,
                        text: `[√Åudio]: ${storagePath}` 
                    });

                    if (dbError) {
                        alert("ERRO: Falha ao registrar mensagem no DB: " + dbError.message);
                    } else {
                        console.log(`Upload de √°udio bem-sucedido para: ${storagePath}`);
                    }
                }
                
                if (audioStream) {
                    audioStream.getTracks().forEach(track => track.stop());
                }
                mediaRecorder = null;
            };

            mediaRecorder.start();
            audioBtn.classList.add('recording');
            isRecording = true;

        } catch (e) {
            console.error("Erro ao acessar o microfone:", e);
            alert("Navegador bloqueou acesso ao microfone ou ocorreu um erro.");
        }
    }
};


/* -----------------------------------------------------------
   VIDEOCONFER√äNCIA (PEERJS)
-----------------------------------------------------------*/
let peer = null;
let currentCall = null;

function setupPeer() {
    // Usa o ID do usu√°rio como Peer ID para que outros possam ligar para ele
    peer = new Peer(user.id, {
        host: 'peerjs-server-olnair.glitch.me', // Usando um PeerJS Server de exemplo
        secure: true,
        port: 443
    });

    peer.on('open', (id) => {
        console.log('Peer ID: ' + id);
        // Informa ao usu√°rio qual √© o ID dele para que outros possam ligar
        callStatus.textContent = "Seu ID: " + id.substring(0, 8) + '...'; 
        chatTitle.textContent = "Chat Brasil Video (" + id.substring(0, 8) + '...)';
    });

    peer.on('call', (call) => {
        // Recebendo uma chamada
        handleIncomingCall(call);
    });

    peer.on('error', (err) => {
        console.error("PeerJS Error:", err);
        callStatus.textContent = "Erro na Conex√£o";
    });

    window.peer = peer;
}

// L√≥gica de iniciar chamada
videoCallBtn.onclick = startCall;

async function startCall() {
    if (!user || !peer) {
        alert("Autentique-se primeiro.");
        return;
    }

    // Pede o ID de destino
    const remotePeerId = prompt("Para quem voc√™ quer ligar? Digite o ID de 8 d√≠gitos do destinat√°rio:");
    if (!remotePeerId) return;
    
    // Procura o ID completo do destinat√°rio.
    let targetId = remotePeerId;
    if (remotePeerId.length < 32) {
        // Simplesmente usa o ID curto como o ID de destino.
        targetId = remotePeerId;
        // NOTA: Em um sistema real, voc√™ buscaria o ID completo no banco de dados.
    }

    if (targetId === user.id) {
        alert("Voc√™ n√£o pode ligar para si mesmo.");
        return;
    }

    try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        window.localStream = stream;

        // Exibe a tela de v√≠deo
        videoCallArea.style.display = 'flex';
        localVideo.srcObject = stream;
        callStatus.textContent = "Chamando...";

        // Inicia a chamada
        const call = peer.call(targetId, stream);
        currentCall = call;

        call.on('stream', (remoteStream) => {
            // Recebe o stream do outro lado
            remoteVideo.srcObject = remoteStream;
            callStatus.textContent = "Em Chamada com " + targetId.substring(0, 8) + '...';
        });

        call.on('close', () => {
            endCallUI();
        });

        call.on('error', (err) => {
            console.error("Call Error:", err);
            // Verifica o tipo de erro para dar um feedback melhor
            if (err.type === 'peer-unavailable') {
                alert(`Erro na chamada: O usu√°rio ${targetId} n√£o est√° online ou o ID est√° incorreto.`);
            } else {
                alert("Erro na chamada: " + err.message);
            }
            endCallUI();
        });

    } catch (e) {
        console.error("Erro ao acessar c√¢mera/microfone:", e);
        alert("ERRO: Permiss√£o de c√¢mera/microfone negada ou n√£o dispon√≠vel.");
        endCallUI();
    }
}

async function handleIncomingCall(call) {
    if (currentCall) {
        // Rejeita se j√° estiver em uma chamada
        call.close();
        return;
    }

    // Pega o ID curto de quem est√° ligando para o alerta
    const callerIdShort = call.peer.substring(0, 8) + '...'; 
    
    // Usamos um prompt para simular o "aceitar/rejeitar"
    const isAccepted = confirm(`Chamada recebida de ${callerIdShort}. Deseja atender?`);

    if (!isAccepted) {
        call.close();
        return;
    }

    try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        window.localStream = stream;

        // Exibe a tela de v√≠deo
        videoCallArea.style.display = 'flex';
        localVideo.srcObject = stream;
        callStatus.textContent = "Atendendo...";

        // Responde √† chamada com o stream local
        call.answer(stream);
        currentCall = call;

        call.on('stream', (remoteStream) => {
            remoteVideo.srcObject = remoteStream;
            callStatus.textContent = "Em Chamada com " + callerIdShort;
        });
        
        call.on('close', () => {
            endCallUI();
        });

        call.on('error', (err) => {
            console.error("Call Error:", err);
            alert("Erro na chamada: " + err.message);
            endCallUI();
        });

    } catch (e) {
        console.error("Erro ao acessar c√¢mera/microfone:", e);
        alert("ERRO: Permiss√£o de c√¢mera/microfone negada para atender.");
        call.close();
        endCallUI();
    }
}

function hangUpCall() {
    if (currentCall) {
        currentCall.close(); // Fecha a conex√£o PeerJS
    }
    endCallUI();
}

function endCallUI() {
    if (window.localStream) {
        window.localStream.getTracks().forEach(track => track.stop());
        window.localStream = null;
    }
    localVideo.srcObject = null;
    remoteVideo.srcObject = null;
    currentCall = null;
    videoCallArea.style.display = 'none';
    callStatus.textContent = "Chamada Encerrada";
    
    // Ap√≥s encerrar, tenta reestabelecer o Peer ID local
    if(user && !peer.destroyed) {
        // Reestabelece o Peer ID local
        setupPeer();
    }
}


/* -----------------------------------------------------------
   INICIALIZA√á√ÉO
-----------------------------------------------------------*/
function initializeChat() {
    if (user) {
        loginModal.style.display = "none";
        // O t√≠tulo ser√° atualizado no setupPeer para incluir o ID do Peer
        chatTitle.textContent = "Chat Brasil Video (Aguardando ID...)";
        loadHistory();
        subscribeToMessages();
        setupPeer(); // Inicializa o PeerJS
    } else {
        loginModal.style.display = "flex";
    }
}

sb.auth.getSession().then(({ data: { session } }) => {
    if (session) {
        user = session.user;
    }
    initializeChat();
});


/* -----------------------------------------------------------
   EXPOSE FUNCTIONS TO WINDOW
-----------------------------------------------------------*/
window.login = login;
window.register = register;
window.reset = reset;
window.logout = logout;
window.setBackground = setBackground;
window.uploadFile = uploadFile; 
window.hangUpCall = hangUpCall;
window.confirmClearChat = confirmClearChat; 
</script>

</body>
</html>

